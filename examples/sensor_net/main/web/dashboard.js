var LT=String.fromCharCode(60);var LTS=LT+'/';function esc(s){return (s||'').replace(/&/g,'&amp;').replace(new RegExp(LT,'g'),'&lt;').replace(/"/g,'&quot;');}function el(id){return document.getElementById(id);}function setText(id,v){var e=el(id);if(e)e.textContent=v;}function setPct(id,p){var e=el(id);if(e)e.style.width=(p!=null&&p>=0?p:0)+'%';}function fmtB(v){var x=Number(v);if(!isFinite(x))return '-';if(x>=1048576)return (x/1048576).toFixed(1)+' MB';return Math.round(x/1024)+' kB';}function fmtUp(ms){var t=Math.max(0,Math.floor(Number(ms)/1000)),d=Math.floor(t/86400),h=Math.floor((t%=86400)/3600),m=Math.floor((t%=3600)/60),s=t%60;var p=[];if(d>0)p.push(d+'d');if(h>0||d>0)p.push(h+'h');if(m>0||h>0||d>0)p.push(m+'m');p.push(s+'s');return p.join(' ');}function fmtMotionLast(gatewayUptimeMs,lastMotionSeenMs){if(lastMotionSeenMs==null||lastMotionSeenMs===0)return '-';var elapsed=Number(gatewayUptimeMs)-Number(lastMotionSeenMs);if(elapsed<0)elapsed=0;if(elapsed<60000)return 'Just now';if(elapsed<3600000)return Math.floor(elapsed/60000)+' min ago';if(elapsed<86400000)return Math.floor(elapsed/3600000)+' h ago';return Math.floor(elapsed/86400000)+' d ago';}function c2f(c){return Number(c)*9/5+32;}function gasAqi(g){if(g==null||g==='')return null;var x=Number(g);if(!isFinite(x))return null;if(0>=x)return 500;if(x>=300)return 0;return Math.round(Math.max(0,Math.min(500,(300-x)/300*500)));}function mmwaveDesc(n){if(!n||((n.mmwave_state==null||n.mmwave_state===0)&&!n.mmwave_moving_cm&&!n.mmwave_stationary_cm))return '';var a=n.mmwave_moving_cm!=null?(Number(n.mmwave_moving_cm)*0.0328084).toFixed(1):'0';var b=n.mmwave_stationary_cm!=null?(Number(n.mmwave_stationary_cm)*0.0328084).toFixed(1):'0';return ' '+a+' ft / '+b+' ft';}function mmwavePresenceText(n){if(!n)return '-';var s=n.mmwave_state;if(s==null&&(n.mmwave_moving_cm==null||n.mmwave_moving_cm===0)&&(n.mmwave_stationary_cm==null||n.mmwave_stationary_cm===0))return '-';return (s&&s!==0)?'Yes':'No';}function mmwaveMovingFt(n){if(!n||(n.mmwave_moving_cm==null&&n.mmwave_stationary_cm==null))return '-';return n.mmwave_moving_cm!=null?(Number(n.mmwave_moving_cm)*0.0328084).toFixed(1):'-';}function mmwaveStationaryFt(n){if(!n||(n.mmwave_moving_cm==null&&n.mmwave_stationary_cm==null))return '-';return n.mmwave_stationary_cm!=null?(Number(n.mmwave_stationary_cm)*0.0328084).toFixed(1):'-';}function mmwaveMovingEnergy(n){if(!n||(n.mmwave_moving_energy==null&&n.mmwave_stationary_energy==null))return '-';return n.mmwave_moving_energy!=null?String(n.mmwave_moving_energy):'-';}function mmwaveStationaryEnergy(n){if(!n||(n.mmwave_moving_energy==null&&n.mmwave_stationary_energy==null))return '-';return n.mmwave_stationary_energy!=null?String(n.mmwave_stationary_energy):'-';}function mmwaveDetectionFt(n){if(!n||n.mmwave_detection_dist_cm==null)return '-';return (Number(n.mmwave_detection_dist_cm)*0.0328084).toFixed(1)+' ft';}function firstMoisture(m){if(m==null)return null;if(typeof m==='number')return m>=0?m:null;if(Array.isArray(m)){for(var i=0;i<m.length;i++){if(m[i]!=null&&m[i]>=0)return m[i];}}return null;}function moistureChannels(m){if(m==null)return[];if(typeof m==='number')return[m>=0?m:null];if(Array.isArray(m)){var r=[];for(var i=0;i<m.length;i++){r.push(m[i]!=null&&m[i]>=0?m[i]:null);}return r;}return[];}function moistureColor(v){if(v==null||v<0)return'#666';if(v<25)return'#ff4444';if(v<50)return'#ffa500';return'#44bb44';}function moistureBarHtml(idx,v,plabel,mac){var pct=v!=null&&v>=0?Math.min(100,v):0;var col=moistureColor(v);var label=v!=null&&v>=0?v.toFixed(1)+'%':'-';var name=plabel||('Plant '+(idx+1));return LT+'div class="moisture-bar-row"'+'>'+LT+'span class="moisture-label plant-label-editable" data-mac="'+(mac||'')+'" data-ch="'+idx+'" title="Click to rename"'+'>'+esc(name)+LTS+'span>'+LT+'div class="moisture-bar"'+'>'+LT+'div class="moisture-fill" style="width:'+pct+'%;background:'+col+'"'+'>'+LTS+'div>'+LTS+'div>'+LT+'span class="moisture-value"'+'>'+label+LTS+'span>'+LTS+'div>';}function tempLabelForNode(n){if(!n)return 'Air temp (F)';var hasWater=n.temperature_water!=null&&isFinite(n.temperature_water)&&n.temperature_water>-500;if(hasWater)return 'Air temp (F)';var l=(n.label||'').toLowerCase();var isTank=l.indexOf('tank')>=0||l.indexOf('aquarium')>=0||l.indexOf('fish')>=0;var isWater=n.temperature!=null&&isFinite(n.temperature)&&(n.humidity==null||!isFinite(n.humidity)||Number(n.humidity)===0);return (isTank||isWater)?'Water temp (F)':'Air temp (F)';}function showTab(tid){var i,p,btns=document.querySelectorAll('.tabs button'),panels=document.querySelectorAll('.panel');for(i=0;btns.length>i;i++){btns[i].classList.toggle('active',btns[i].getAttribute('data-tab')===tid);}for(i=0;panels.length>i;i++){panels[i].classList.toggle('active',panels[i].id===tid);}}function fetchDebug(){fetch('/api/debug').then(function(r){return r.json();}).then(function(j){if(!j)return;if(j.gateway_2g_only){document.body.classList.add('gateway-2g-only');document.title='SENSORnet Gateway';}setText('statHeapFree',fmtB(j.heap_free));setText('statHeapUsed',fmtB(j.heap_used));setText('statHeapMinFree',fmtB(j.heap_min_free));setText('statHeapPct',j.heap_used_pct!=null?j.heap_used_pct+'%':'-');setText('statCpuPct',j.cpu_usage_pct!=null?j.cpu_usage_pct+'%':'-');setText('statNodes',j.node_count!=null?String(j.node_count):'-');setText('statGateways',j.gateway_count!=null?String(j.gateway_count):'-');setText('topNodesText','Nodes: '+(j.node_count!=null?j.node_count:'-')+' | Gateways: '+(j.gateway_count!=null?j.gateway_count:'-'));setText('topEspnowStatus',j.espnow_enabled!=null?(j.espnow_enabled?'ON':'OFF'):'-');var up='-';if(j.gateway_uptime_ms!=null)up=fmtUp(j.gateway_uptime_ms);else if(j.uptime_ms!=null)up=fmtUp(j.uptime_ms);else if(j.uptime_s!=null)up=fmtUp(Number(j.uptime_s)*1000);setText('topUptime','Uptime: '+up);setPct('statCpuFill',j.cpu_usage_pct);var si=el('systemIndicator');if(si){si.classList.remove('ok','warn','crit');if(j.heap_used_pct>=90)si.classList.add('crit');else if(j.heap_used_pct>=80)si.classList.add('warn');else si.classList.add('ok');}if(el('overview')&&el('overview').classList.contains('active'))renderOverview();}).catch(function(){});}function fetchHalow(){fetch('/api/halow').then(function(r){return r.json();}).then(function(j){var h=j,s=el('halowStatus'),m=el('halowMac'),d=el('halowData'),ind=el('halowIndicator'),rF=el('halowRssiFill'),rD=el('halowRssiDbm'),tF=el('halowTopRssiFill'),tT=el('halowTopRssiText'),tI=el('halowTopIp');if(!s)return;if(!h){s.textContent='Unavailable';if(m)m.textContent='MAC: -';if(d)d.innerHTML='';if(ind){ind.classList.remove('up');ind.classList.add('down');}if(rF)rF.style.width='0%';if(rD)rD.textContent='-';if(tF)tF.style.width='0%';if(tT)tT.textContent='- dBm';if(tI)tI.textContent='IP: -';return;}s.textContent=h.up?'Connected':'Disconnected';if(ind){ind.classList.toggle('up',!!h.up);ind.classList.toggle('down',!h.up);}var rv=h.rssi_dbm!=null?Number(h.rssi_dbm):null,pct=0;if(rv!=null&&isFinite(rv))pct=Math.round(Math.max(0,Math.min(100,(rv+100)/70*100)));if(rF)rF.style.width=pct+'%';if(rD)rD.textContent=rv!=null?rv+' dBm':'-';if(tF)tF.style.width=pct+'%';if(tT)tT.textContent=rv!=null?rv+' dBm':'- dBm';if(tI)tI.textContent='IP: '+(h.ip||'-');if(m)m.textContent='MAC: '+(h.mac||'-');if(d)d.innerHTML=LT+'div>'+LT+'span>IP'+LTS+'span>'+LT+'strong>'+(h.ip||'-')+LTS+'strong>'+LTS+'div>';if(el('overview')&&el('overview').classList.contains('active'))renderOverview();}).catch(function(){var s=el('halowStatus');if(s)s.textContent='Unavailable';});}function wifiRssiPct(rssi){if(rssi==null||!isFinite(rssi))return 0;return Math.round(Math.max(0,Math.min(100,(Number(rssi)+90)/60*100)));}
function fetchWifi2g(){fetch('/api/wifi2g').then(function(r){return r.json();}).then(function(j){var ap=j&&j.ap||{},sta=j&&j.sta||{};var is2g=(j.backhaul_mode==='wifi2g');setText('wifi2gApSsid',ap.ssid||'-');setText('wifi2gApClients',ap.clients!=null?String(ap.clients):'-');setText('wifi2gApIp',ap.ip||'-');setText('wifi2gBackhaul',j.backhaul_mode==='halow'?'HaLow':'2.4 GHz');setText('wifi2gStaSsid',sta.ssid||'-');setText('wifi2gStaRssi',sta.rssi_dbm!=null?sta.rssi_dbm+' dBm':'-');setText('wifi2gStaIp',sta.ip||'-');setText('halowTopTitle',is2g?'2.4 GHz RSSI':'HaLow RSSI');var rv=sta.rssi_dbm!=null?Number(sta.rssi_dbm):null,pct=wifiRssiPct(rv);setPct('wifi2gStaRssiFill',pct);setText('wifi2gStaRssiDbm',rv!=null?rv+' dBm':'-');if(is2g){var hF=el('halowTopRssiFill'),hT=el('halowTopRssiText'),hI=el('halowTopIp');if(hF)hF.style.width=pct+'%';if(hT)hT.textContent=rv!=null?rv+' dBm':'- dBm';if(hI)hI.textContent='IP: '+(sta.ip||'-');}var staTop=document.querySelector('.wifi-sta-top');if(staTop)staTop.style.display=is2g?'none':'';var tF=el('wifiTopRssiFill'),tT=el('wifiTopRssiText'),tI=el('wifiTopIp');if(tF)tF.style.width=pct+'%';if(tT)tT.textContent=rv!=null?rv+' dBm':'- dBm';if(tI)tI.textContent='IP: '+(sta.ip||'-');var ws=el('wifiStaStatus'),wD=el('wifiStaRssiDbm'),wI=el('wifiStaIpCollapsed'),wF=el('wifiStaRssiFill'),wInd=el('wifiStaIndicator');if(ws){ws.textContent=sta.ip?'Connected':'Disconnected';}if(wInd){wInd.classList.toggle('up',!!sta.ip);wInd.classList.toggle('down',!sta.ip);}if(wF)wF.style.width=pct+'%';if(wD)wD.textContent=rv!=null?rv+' dBm':'-';if(wI)wI.textContent='IP: '+(sta.ip||'-');if(el('overview')&&el('overview').classList.contains('active'))renderOverview();}).catch(function(){});}var motionDismissed={};var _tankOverviewStatus='-',_tankOverviewTemp='-';function saveMotion(){try{localStorage.setItem('motionDismissed',JSON.stringify(motionDismissed));}catch(e){}}function isDismissed(mac,trig){var m=motionDismissed[mac];return m&&m.t===trig&&30000>(Date.now()-(m.ts||0));}function cameraStreamHostForNode(n){if(!n)return null;var h=(n.stream_host||'').trim();return h||null;}function updateCardInPlace(card,n,j){var stale=(j.gateway_uptime_ms!=null&&n.last_seen_ms!=null)?(j.gateway_uptime_ms-n.last_seen_ms)>180000:false;var trigCount=Number(n.trigger_count)||0;var alarm=n.motion==1&&!isDismissed(n.mac,trigCount);var lbl=esc(n.label||n.mac);var tF=n.temperature!=null&&isFinite(n.temperature)?c2f(n.temperature):null;var hT=n.humidity!=null?Number(n.humidity).toFixed(1):'-';var aqi=gasAqi(n.gas);var aT=aqi!=null?String(aqi):'-';var mot=n.motion==1?(alarm?'Yes':'Cleared'):'No';mot+=mmwaveDesc(n);var rssiStr=(!stale&&n.rssi_dbm===0)?'HaLow':(n.rssi_dbm!=null&&isFinite(n.rssi_dbm)?n.rssi_dbm+' dBm':'-');var uptimeStr=(n.uptime_ms!=null&&n.uptime_ms!==undefined)?fmtUp(n.uptime_ms):'-';if(!uptimeStr)uptimeStr='-';card.setAttribute('data-trigger',trigCount);card.className='sensor-card'+(alarm?' motion':'')+(stale?' stale':'');var t=card.querySelector('.sensor-title');if(t)t.textContent=lbl;var m=card.querySelector('.mac');if(m)m.textContent=n.mac;var rows=card.querySelectorAll('.row');if(rows[0]){var v=rows[0].querySelector('.v');if(v)v.textContent=mot;}if(rows[1]){var v=rows[1].querySelector('.v');if(v)v.textContent=mmwavePresenceText(n);}if(rows[2]){var v=rows[2].querySelector('.v');if(v)v.textContent=mmwaveMovingFt(n);}if(rows[3]){var v=rows[3].querySelector('.v');if(v)v.textContent=mmwaveStationaryFt(n);}if(rows[4]){var v=rows[4].querySelector('.v');if(v)v.textContent=mmwaveMovingEnergy(n);}if(rows[5]){var v=rows[5].querySelector('.v');if(v)v.textContent=mmwaveStationaryEnergy(n);}if(rows[6]){var v=rows[6].querySelector('.v');if(v)v.textContent=mmwaveDetectionFt(n);}if(rows[7]){var v=rows[7].querySelector('.v');if(v)v.textContent=rssiStr;}if(rows[8]){var v=rows[8].querySelector('.v');if(v)v.textContent=(tF!=null)?tF.toFixed(1):'-';var k=rows[8].querySelector('.k');if(k)k.textContent=tempLabelForNode(n);}var waterRow=card.querySelector('.row-water-temp');if(waterRow){var wv=waterRow.querySelector('.v');if(wv)wv.textContent=(n.temperature_water!=null&&isFinite(n.temperature_water)&&n.temperature_water>-500)?c2f(n.temperature_water).toFixed(1):'-';waterRow.classList.toggle('row-soil-hidden',!(n.temperature_water!=null&&isFinite(n.temperature_water)&&n.temperature_water>-500));}var tdsRow=card.querySelector('.row-tds');if(tdsRow){var tv=tdsRow.querySelector('.v');if(tv)tv.textContent=(n.tds_ppm!=null&&isFinite(n.tds_ppm)&&n.tds_ppm>=0)?Number(n.tds_ppm).toFixed(0):'-';tdsRow.classList.toggle('row-soil-hidden',!(n.tds_ppm!=null&&isFinite(n.tds_ppm)&&n.tds_ppm>=0));}if(rows[11]){var v=rows[11].querySelector('.v');if(v)v.textContent=hT;}var soilRow=card.querySelector('.row-soil')||(card.querySelectorAll('.row')[12]);if(soilRow){soilRow.classList.add('row-soil');var fm7=firstMoisture(n.moisture);soilRow.classList.toggle('row-soil-hidden',fm7==null);var v=soilRow.querySelector('.v');if(v)v.textContent=(fm7!=null)?fm7.toFixed(1):'-';}if(rows[13]){var v=rows[13].querySelector('.v');if(v)v.textContent=aT;}if(rows[14]){var v=rows[14].querySelector('.v');if(v)v.textContent=trigCount;}var motionLastStr=fmtMotionLast(j.gateway_uptime_ms,n.last_motion_seen_ms);if(rows[15]){var v=rows[15].querySelector('.v');if(v)v.textContent=motionLastStr;}if(rows[16]){var v=rows[16].querySelector('.v');if(v)v.textContent=uptimeStr;}var sel=card.querySelector('.sensor-location');if(sel)sel.value=n.location||'indoor';var streamHost=(n.is_camera?cameraStreamHostForNode(n):null);if(streamHost&&rows[17]){var v=rows[17].querySelector('.v');if(v)v.textContent=streamHost;}card.querySelectorAll('.row').forEach(function(r){var v=r.querySelector('.v');if(v){var t=(v.textContent||'').trim();r.classList.toggle('row-empty',t==='-'||t===''||t==='0'||(!isNaN(parseFloat(t))&&parseFloat(t)===0));}});}function fetchSensors(){fetch('/api/sensors').then(function(r){return r.json();}).then(function(j){var nodes=(j&&j.nodes)||[],grid=el('sensorCards');var indoorNodes=nodes.filter(function(x){return x&&x.mac&&(x.location||'indoor')==='indoor';});var outdoorNodes=nodes.filter(function(x){return x&&x.mac&&x.location==='outdoor';});var sumTi=0,sumHi=0,sumAi=0,sumPi=0,countTi=0,countHi=0,countAi=0,countPi=0,i,n;for(i=0;i<indoorNodes.length;i++){n=indoorNodes[i];if(n.temperature!=null&&isFinite(n.temperature)){sumTi+=c2f(n.temperature);countTi++;}if(n.humidity!=null&&isFinite(n.humidity)){sumHi+=Number(n.humidity);countHi++;}var a=gasAqi(n.gas);if(a!=null){sumAi+=a;countAi++;}if(n.pressure!=null&&isFinite(n.pressure)){sumPi+=Number(n.pressure);countPi++;}}var indoorStr='-';if(countTi>0||countHi>0||countAi>0||countPi>0){var pts=[];pts.push(countTi>0?(sumTi/countTi).toFixed(1)+'F':'-');pts.push(countHi>0?(sumHi/countHi).toFixed(1)+'%':'-');pts.push(countAi>0?Math.round(sumAi/countAi).toString():'-');pts.push(countPi>0?(sumPi/countPi).toFixed(1)+' hPa':'-');indoorStr=pts.join(' / ');}setText('motionSummaryIndoor',indoorStr);setText('motionSummaryIndoorSub',indoorNodes.length+' sensors');var sumTo=0,sumHo=0,sumAo=0,sumPo=0,countTo=0,countHo=0,countAo=0,countPo=0;for(i=0;i<outdoorNodes.length;i++){n=outdoorNodes[i];if(n.temperature!=null&&isFinite(n.temperature)){sumTo+=c2f(n.temperature);countTo++;}if(n.humidity!=null&&isFinite(n.humidity)){sumHo+=Number(n.humidity);countHo++;}a=gasAqi(n.gas);if(a!=null){sumAo+=a;countAo++;}if(n.pressure!=null&&isFinite(n.pressure)){sumPo+=Number(n.pressure);countPo++;}}var outdoorStr='-';if(countTo>0||countHo>0||countAo>0||countPo>0){var pts=[];pts.push(countTo>0?(sumTo/countTo).toFixed(1)+'F':'-');pts.push(countHo>0?(sumHo/countHo).toFixed(1)+'%':'-');pts.push(countAo>0?Math.round(sumAo/countAo).toString():'-');pts.push(countPo>0?(sumPo/countPo).toFixed(1)+' hPa':'-');outdoorStr=pts.join(' / ');}setText('motionSummaryOutdoor',outdoorStr);setText('motionSummaryOutdoorSub',outdoorNodes.length+' sensors');if(!grid)return;var total=0,active=0,i,n;var nodeByMac={};for(i=0;i<nodes.length;i++){n=nodes[i];if(!n||!n.mac)continue;nodeByMac[n.mac]=n;total++;var stale=(j.gateway_uptime_ms!=null&&n.last_seen_ms!=null)?(j.gateway_uptime_ms-n.last_seen_ms)>180000:false;var trigCount=Number(n.trigger_count)||0;if(n.motion==1&&!isDismissed(n.mac,trigCount))active++;}var existingByMac={};grid.querySelectorAll('.sensor-card').forEach(function(c){var m=c.getAttribute('data-mac');if(m)existingByMac[m]=c;});var currentMacs=nodes.filter(function(x){return x&&x.mac;}).map(function(x){return x.mac;}).sort().join(',');var existingMacs=Array.from(grid.querySelectorAll('.sensor-card')).map(function(c){return c.getAttribute('data-mac');}).filter(Boolean).sort().join(',');if(currentMacs&&currentMacs===existingMacs){for(i=0;i<nodes.length;i++){n=nodes[i];if(!n||!n.mac)continue;if(existingByMac[n.mac])updateCardInPlace(existingByMac[n.mac],n,j);}}else{var html=[];for(i=0;i<nodes.length;i++){n=nodes[i];if(!n||!n.mac)continue;var stale=(j.gateway_uptime_ms!=null&&n.last_seen_ms!=null)?(j.gateway_uptime_ms-n.last_seen_ms)>180000:false;var trigCount=Number(n.trigger_count)||0;var alarm=n.motion==1&&!isDismissed(n.mac,trigCount);var lbl=esc(n.label||n.mac);var tF=n.temperature!=null&&isFinite(n.temperature)?c2f(n.temperature):null;var hT=n.humidity!=null?Number(n.humidity).toFixed(1):'-';var aqi=gasAqi(n.gas);var aT=aqi!=null?String(aqi):'-';var mot=n.motion==1?(alarm?'Yes':'Cleared'):'No';mot+=mmwaveDesc(n);var streamHost=(n.is_camera?cameraStreamHostForNode(n):null);var loc=n.location||'indoor';var viewBtn=streamHost?(LT+'button type="button" class="btnViewStream" data-stream="http://'+streamHost+'/live"'+'>View'+LTS+'button>'):'';var settingsBtn=streamHost?(LT+'a href="http://'+streamHost+'/" class="btnCameraSettings" target="_blank" rel="noopener noreferrer"'+'>Settings'+LTS+'a>'):'';var card=LT+'div class="sensor-card'+(alarm?' motion':'')+(stale?' stale':'')+'" data-mac="'+n.mac+'" data-trigger="'+(n.trigger_count||0)+'"'+'>'+LT+'h4'+'>'+LT+'span class="sensor-title"'+'>'+lbl+LTS+'span> '+LT+'button type="button" class="btnEditLabel" data-mac="'+n.mac+'"'+'>Edit'+LTS+'button>'+LTS+'h4>'+LT+'div class="mac"'+'>'+n.mac+LTS+'div>'+((n.is_camera&&streamHost)?(LT+'div class="camera-stream-wrap" data-stream-host="http://'+streamHost+'"'+'>'+LT+'div class="camera-stream-overlay" title="Click for fullscreen"'+'>'+LTS+'div>'+LTS+'div>'+LT+'div class="camera-audio-wrap"'+'>'+LT+'audio class="camera-audio" controls preload="none" src="http://'+streamHost+'/audio"'+'>'+LTS+'audio>'+LTS+'div>'+LT+'div class="camera-details-wrap collapsed"'+'>'+LT+'button type="button" class="camera-details-toggle"'+'>Details'+LTS+'button>'+LT+'div class="camera-details-body"'+'>'):'')+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Motion'+LTS+'span>'+LT+'span class="v sensor-motion"'+'>'+mot+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Presence'+LTS+'span>'+LT+'span class="v"'+'>'+mmwavePresenceText(n)+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Moving (ft)'+LTS+'span>'+LT+'span class="v"'+'>'+mmwaveMovingFt(n)+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Stationary (ft)'+LTS+'span>'+LT+'span class="v"'+'>'+mmwaveStationaryFt(n)+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Moving energy'+LTS+'span>'+LT+'span class="v"'+'>'+mmwaveMovingEnergy(n)+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Stationary energy'+LTS+'span>'+LT+'span class="v"'+'>'+mmwaveStationaryEnergy(n)+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Detection (ft)'+LTS+'span>'+LT+'span class="v"'+'>'+mmwaveDetectionFt(n)+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>RSSI'+LTS+'span>'+LT+'span class="v"'+'>'+((!stale&&n.rssi_dbm===0)?'HaLow':(n.rssi_dbm!=null&&isFinite(n.rssi_dbm)?n.rssi_dbm+' dBm':'-'))+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>'+tempLabelForNode(n)+LTS+'span>'+LT+'span class="v"'+'>'+((tF!=null)?tF.toFixed(1):'-')+LTS+'span>'+LTS+'div>'+LT+'div class="row row-water-temp'+(n.temperature_water!=null&&isFinite(n.temperature_water)&&n.temperature_water>-500?'':' row-soil-hidden')+'"'+'>'+LT+'span class="k"'+'>Water temp (F)'+LTS+'span>'+LT+'span class="v"'+'>'+((n.temperature_water!=null&&isFinite(n.temperature_water)&&n.temperature_water>-500)?c2f(n.temperature_water).toFixed(1):'-')+LTS+'span>'+LTS+'div>'+LT+'div class="row row-tds'+(n.tds_ppm!=null&&isFinite(n.tds_ppm)&&n.tds_ppm>=0?'':' row-soil-hidden')+'"'+'>'+LT+'span class="k"'+'>TDS (ppm)'+LTS+'span>'+LT+'span class="v"'+'>'+((n.tds_ppm!=null&&isFinite(n.tds_ppm)&&n.tds_ppm>=0)?Number(n.tds_ppm).toFixed(0):'-')+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>H (%)'+LTS+'span>'+LT+'span class="v"'+'>'+hT+LTS+'span>'+LTS+'div>'+LT+'div class="row row-soil'+(firstMoisture(n.moisture)==null?' row-soil-hidden':'')+'"'+'>'+LT+'span class="k"'+'>Soil (%)'+LTS+'span>'+LT+'span class="v"'+'>'+((function(){var fm=firstMoisture(n.moisture);return fm!=null?fm.toFixed(1):'-';}()))+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>AQI'+LTS+'span>'+LT+'span class="v"'+'>'+aT+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Triggers'+LTS+'span>'+LT+'span class="v"'+'>'+trigCount+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Motion last'+LTS+'span>'+LT+'span class="v"'+'>'+fmtMotionLast(j.gateway_uptime_ms,n.last_motion_seen_ms)+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Uptime'+LTS+'span>'+LT+'span class="v"'+'>'+((n.uptime_ms!=null&&n.uptime_ms!==undefined)?fmtUp(n.uptime_ms):'-')+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Location'+LTS+'span>'+LT+'span class="v"'+'>'+LT+'select class="sensor-location" data-mac="'+n.mac+'"'+'>'+LT+'option value="indoor"'+(loc==='indoor'?' selected':'')+'>Indoor'+LTS+'option>'+LT+'option value="outdoor"'+(loc==='outdoor'?' selected':'')+'>Outdoor'+LTS+'option>'+LTS+'select>'+LTS+'span>'+LTS+'div>';if(n.is_camera&&streamHost){card+=LT+'div class="row"'+'>'+LT+'span class="k"'+'>Camera IP'+LTS+'span>'+LT+'span class="v"'+'>'+esc(streamHost)+LTS+'span>'+LTS+'div>';}card+=LT+'div class="card-actions"'+'>'+LT+'button type="button" class="btnReset" data-mac="'+n.mac+'"'+'>Reset'+LTS+'button>'+LT+'button type="button" class="btnBlink" data-mac="'+n.mac+'"'+'>Blink'+LTS+'button>'+settingsBtn+viewBtn+LTS+'div>';if(n.is_camera&&streamHost){card+=LTS+'div>'+LTS+'div>';}card+=LTS+'div>';html.push(card);}var savedIframes=[];if(grid&&html.length){grid.querySelectorAll('.camera-stream-wrap').forEach(function(w){var i=w.querySelector('iframe');if(i&&i.src){var h=i.src.replace(/\/live.*$/,'');savedIframes.push({host:h,iframe:i});}});}grid.innerHTML=html.length?html.join(''):LT+'p class="muted" style="padding:16px;text-align:center"'+'>No sensors yet. Check Settings for ESP-NOW / HaLow.'+LTS+'p>';if(grid&&html.length){grid.querySelectorAll('.sensor-card').forEach(function(card){card.querySelectorAll('.row').forEach(function(r){var v=r.querySelector('.v');if(v){var t=(v.textContent||'').trim();r.classList.toggle('row-empty',t==='-'||t===''||t==='0'||(!isNaN(parseFloat(t))&&parseFloat(t)===0));}});});grid.querySelectorAll('.camera-stream-wrap').forEach(function(w){var host=w.getAttribute('data-stream-host');if(!host)return;var saved=savedIframes.find(function(p){return p.host===host;});if(saved){w.appendChild(saved.iframe);}else{var ifr=document.createElement('iframe');ifr.className='camera-stream';ifr.src=host+'/live';ifr.title='Live';w.appendChild(ifr);}});}}setText('motionSummaryTotal',total);var sumT=0,sumH=0,sumA=0,sumP=0,countT=0,countH=0,countA=0,countP=0;for(i=0;i<nodes.length;i++){n=nodes[i];if(!n||!n.mac)continue;if(n.temperature!=null&&isFinite(n.temperature)){sumT+=c2f(n.temperature);countT++;}if(n.humidity!=null&&isFinite(n.humidity)){sumH+=Number(n.humidity);countH++;}var a=gasAqi(n.gas);if(a!=null){sumA+=a;countA++;}if(n.pressure!=null&&isFinite(n.pressure)){sumP+=Number(n.pressure);countP++;}}setText('motionSummaryEnvTemp',countT>0?(sumT/countT).toFixed(1)+'F':'-');setText('motionSummaryEnvHum',countH>0?(sumH/countH).toFixed(1)+'%':'-');setText('motionSummaryEnvAqi',countA>0?Math.round(sumA/countA).toString():'-');setText('motionSummaryEnvPressure',countP>0?(sumP/countP).toFixed(1)+' hPa':'-');var lastNode=null,lastSeen=0;for(i=0;i<nodes.length;i++){n=nodes[i];if(!n||!n.mac)continue;var tc=Number(n.trigger_count||0);if(tc===0&&n.motion!==1)continue;var ls=Number(n.last_seen_ms||0);if(ls>lastSeen){lastSeen=ls;lastNode=n;}}var lastVal='-';var lastSub='Most recent trigger';if(lastNode&&j.gateway_uptime_ms!=null){lastVal=esc(lastNode.label||lastNode.mac);var elapsed=Number(j.gateway_uptime_ms)-lastSeen;if(elapsed<0)elapsed=0;if(elapsed<60000)lastSub='Just now';else if(elapsed<3600000)lastSub=Math.floor(elapsed/60000)+' min ago';else if(elapsed<86400000)lastSub=Math.floor(elapsed/3600000)+' h ago';else lastSub=Math.floor(elapsed/86400000)+' d ago';}setText('motionSummaryLast',lastVal);setText('motionSummaryLastLabel',lastSub);setText('topMotionTotal',total);setText('topMotionActive',active);setText('topMotionLast',lastVal);var topIcon=el('topMotionIcon');if(topIcon)topIcon.textContent=active>0?'\u26A0':'\u1F513';var topCard=el('topMotionCard');if(topCard)topCard.classList.toggle('alert',active>0);buildDailyTodo(nodes);if(typeof window.pushPlantMoisture==='function')window.pushPlantMoisture(nodes);var cameraCount=0;for(i=0;i<nodes.length;i++){if(nodes[i]&&cameraStreamHostForNode(nodes[i]))cameraCount++;}setText('statCameras',cameraCount);var sel=el('bleLogSensor');if(sel){var prevBle=sel.value||'';sel.innerHTML='';for(i=0;i<nodes.length;i++){n=nodes[i];if(!n||!n.mac)continue;var o=document.createElement('option');o.value=n.mac;o.textContent=n.label||n.mac;sel.appendChild(o);}if(prevBle){for(var bi=0;bi<sel.options.length;bi++){if(sel.options[bi].value===prevBle){sel.value=prevBle;break;}}}}var wsel=el('wifiLogSensor');if(wsel){var prevWifi=wsel.value||'';wsel.innerHTML='<option value="">Select sensor</option>';for(i=0;i<nodes.length;i++){n=nodes[i];if(!n||!n.mac)continue;var o=document.createElement('option');o.value=n.mac;o.textContent=n.label||n.mac;wsel.appendChild(o);}if(prevWifi){for(var wi=0;wi<wsel.options.length;wi++){if(wsel.options[wi].value===prevWifi){wsel.value=prevWifi;break;}}}}var ae=el('motionSummaryActive');if(ae){ae.textContent=active;ae.classList.toggle('alert',active>0);}var motionCardsEl=el('motionSensorCards');if(motionCardsEl){var motionItems=[];for(i=0;nodes.length>i;i++){var mn=nodes[i];if(!mn||!mn.mac)continue;var md=isDismissed(mn.mac,Number(mn.trigger_count||0));var malarm=mn.motion==1&&!md;var mlbl=esc(mn.label||mn.mac);motionItems.push(LT+'div class="motion-sensor-card'+(malarm?' triggered':'')+'" data-mac="'+mn.mac+'" data-trigger="'+(mn.trigger_count||0)+'"'+'>'+LT+'div class="motion-sensor-name"'+'>'+mlbl+LTS+'div>'+LTS+'div>');}motionCardsEl.innerHTML=motionItems.length?motionItems.join(''):LT+'p class="muted" style="padding:8px;text-align:center"'+'>No sensors connected'+LTS+'p>';motionCardsEl.querySelectorAll('.motion-sensor-card').forEach(function(c){c.onclick=function(){var mac=this.getAttribute('data-mac'),trig=Number(this.getAttribute('data-trigger')||0);if(mac&&trig&&this.classList.contains('triggered')){motionDismissed[mac]={t:trig,ts:Date.now()};saveMotion();this.classList.remove('triggered');}};});}grid.querySelectorAll('.sensor-location').forEach(function(sel){sel.onchange=function(){var mac=this.getAttribute('data-mac'),loc=this.value;if(!mac)return;fetch('/api/location',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:mac,location:loc})}).then(function(){fetchSensors();});};});grid.querySelectorAll('.btnEditLabel').forEach(function(b){b.onclick=function(){var mac=this.getAttribute('data-mac');var lab=el('labelEditInput');el('labelEditMac').textContent=mac;if(lab)lab.value=(this.closest('.sensor-card').querySelector('.sensor-title')||{}).textContent||'';el('labelEditForm').classList.add('show');editingMac=mac;};});grid.querySelectorAll('.btnReset').forEach(function(b){b.onclick=function(){var mac=this.getAttribute('data-mac');if(!mac||!confirm('Reset trigger for '+mac+'?'))return;fetch('/api/sensors/reset',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:mac})}).then(function(){fetchSensors();});};});grid.querySelectorAll('.btnBlink').forEach(function(b){b.onclick=function(){var mac=this.getAttribute('data-mac');if(mac)fetch('/api/sensors/blink',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:mac})});};});grid.querySelectorAll('.btnViewStream').forEach(function(b){b.onclick=function(){var u=this.getAttribute('data-stream');if(u)window.open(u,'_blank','noopener,noreferrer');};});grid.querySelectorAll('.camera-stream-overlay').forEach(function(ov){ov.onclick=function(){var wrap=this.closest('.camera-stream-wrap');if(!wrap)return;var fs=document.fullscreenElement||document.webkitFullscreenElement;if(fs){(document.exitFullscreen||document.webkitExitFullscreen).call(document);}else{var req=wrap.requestFullscreen||wrap.webkitRequestFullscreen;if(req){var p=req.call(wrap,req===wrap.requestFullscreen?{navigationUI:'hide'}:undefined);if(p&&typeof p.catch==='function')p.catch(function(){});}else{var u=wrap.getAttribute('data-stream-host');if(u)window.open((u.replace(/\/$/,''))+'/live','_blank','noopener');}}};});grid.querySelectorAll('.camera-details-toggle').forEach(function(btn){btn.onclick=function(e){e.stopPropagation();var w=this.closest('.camera-details-wrap');if(w)w.classList.toggle('open');};});grid.querySelectorAll('.sensor-card').forEach(function(c){c.onclick=function(e){if(e.target.closest('button'))return;var mac=this.getAttribute('data-mac'),trig=Number(this.getAttribute('data-trigger')||0);if(mac&&trig&&this.classList.contains('motion')){motionDismissed[mac]={t:trig,ts:Date.now()};saveMotion();this.classList.remove('motion');var mm=this.querySelector('.v.sensor-motion');if(mm)mm.textContent='Cleared';}};});if(el('overview')&&el('overview').classList.contains('active'))renderOverview();}).catch(function(){var g=el('sensorCards');if(g)g.innerHTML=LT+'p class="muted"'+'>Could not load sensors.'+LTS+'p>';});}var editingMac=null;function saveLabel(){if(!editingMac)return;var lab=el('labelEditInput');fetch('/api/labels',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:editingMac,label:lab?lab.value.trim():''})}).then(function(){editingMac=null;el('labelEditForm').classList.remove('show');fetchSensors();});}function renderGarden(){fetch('/api/sensors').then(function(r){return r.json();}).then(function(j){var nodes=j.nodes||[],outdoor=nodes.filter(function(n){return n&&n.mac&&n.location==='outdoor';}),grid=el('gardenSensorCards'),i,n;if(!grid)return;var sumT=0,sumH=0,sumA=0,sumP=0,countT=0,countH=0,countA=0,countP=0;for(i=0;i<outdoor.length;i++){n=outdoor[i];if(n.temperature!=null&&isFinite(n.temperature)){sumT+=c2f(n.temperature);countT++;}if(n.humidity!=null&&isFinite(n.humidity)){sumH+=Number(n.humidity);countH++;}var a=gasAqi(n.gas);if(a!=null){sumA+=a;countA++;}if(n.pressure!=null&&isFinite(n.pressure)){sumP+=Number(n.pressure);countP++;}}setText('gardenSensorCount',outdoor.length);setText('gardenSensorCountSub',outdoor.length+' online');setText('gardenTemp',countT>0?(sumT/countT).toFixed(1)+'F':'-');setText('gardenHum',countH>0?(sumH/countH).toFixed(1)+'%':'-');setText('gardenAqi',countA>0?Math.round(sumA/countA).toString():'-');setText('gardenPressure',countP>0?(sumP/countP).toFixed(1)+' hPa':'-');if(!outdoor.length){grid.innerHTML=LT+'p class="muted" style="padding:16px;text-align:center"'+'>No outdoor sensors. Set sensors to Outdoor on the Sensors tab.'+LTS+'p>';return;}var html=[];for(i=0;i<outdoor.length;i++){n=outdoor[i];var lbl=esc(n.label||n.mac),tF=n.temperature!=null&&isFinite(n.temperature)?c2f(n.temperature):null,hT=n.humidity!=null?Number(n.humidity).toFixed(1):'-',aqi=gasAqi(n.gas),aT=aqi!=null?String(aqi):'-',pr=n.pressure!=null&&isFinite(n.pressure)?Number(n.pressure).toFixed(1):'-';html.push(LT+'div class="sensor-card" data-mac="'+n.mac+'"'+'>'+LT+'h4'+'>'+LT+'span class="sensor-title"'+'>'+lbl+LTS+'span>'+LTS+'h4>'+LT+'div class="mac"'+'>'+n.mac+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Air temp (F)'+LTS+'span>'+LT+'span class="v"'+'>'+(tF!=null?tF.toFixed(1):'-')+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>H (%)'+LTS+'span>'+LT+'span class="v"'+'>'+hT+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>AQI'+LTS+'span>'+LT+'span class="v"'+'>'+aT+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>P (hPa)'+LTS+'span>'+LT+'span class="v"'+'>'+pr+LTS+'span>'+LTS+'div>'+LTS+'div>');}grid.innerHTML=html.join('');}).catch(function(){});}function renderVideo(){fetch('/api/sensors').then(function(r){return r.json();}).then(function(j){var nodes=j.nodes||[],cameras=[],i,n,grid=el('videoStreamGrid');if(!grid)return;for(i=0;i<nodes.length;i++){n=nodes[i];if(!n||!n.mac)continue;var host=cameraStreamHostForNode(n);if(host){cameras.push({node:n,host:host});}}if(!cameras.length){grid.innerHTML=LT+'p class="muted" style="padding:16px;text-align:center"'+'>No camera streams. Use a camera unit (sensor_unit_camera) in range; it needs an IP (HaLow or WiFi).'+LTS+'p>';return;}var baseUrl='http://';var html=[];for(i=0;i<cameras.length;i++){var c=cameras[i],h=baseUrl+c.host,lbl=esc(c.node.label||c.node.mac);html.push(LT+'div class="sensor-card" style="min-width:280px"'+'>'+LT+'h4 class="sensor-title"'+'>'+lbl+LTS+'h4>'+LT+'div class="camera-stream-wrap" data-stream-host="'+h+'"'+'>'+LT+'div class="camera-stream-overlay" title="Click for fullscreen"'+'>'+LTS+'div>'+LTS+'div>'+LT+'div class="camera-audio-wrap"'+'>'+LT+'audio class="camera-audio" controls preload="none" src="'+h+'/audio"'+'>'+LTS+'audio>'+LTS+'div>'+LT+'div class="camera-details-wrap collapsed"'+'>'+LT+'button type="button" class="camera-details-toggle"'+'>Details'+LTS+'button>'+LT+'a href="'+h+'/" target="_blank" rel="noopener noreferrer" class="btnCameraSettings"'+'>Settings'+LTS+'a>'+LT+'a href="'+h+'/live" target="_blank" rel="noopener noreferrer"'+'>Open in new tab'+LTS+'a>'+LTS+'div>'+LTS+'div>');}grid.innerHTML=html.join('');grid.querySelectorAll('.camera-stream-wrap').forEach(function(w){var host=w.getAttribute('data-stream-host');if(!host)return;var ifr=document.createElement('iframe');ifr.className='camera-stream';ifr.src=host+'/live';ifr.title='Live';w.insertBefore(ifr,w.firstChild);});grid.querySelectorAll('.camera-stream-overlay').forEach(function(ov){ov.onclick=function(){var wrap=this.closest('.camera-stream-wrap');if(!wrap)return;var fs=document.fullscreenElement||document.webkitFullscreenElement;if(fs){(document.exitFullscreen||document.webkitExitFullscreen).call(document);}else{var req=wrap.requestFullscreen||wrap.webkitRequestFullscreen;if(req){var p=req.call(wrap,req===wrap.requestFullscreen?{navigationUI:'hide'}:undefined);if(p&&typeof p.catch==='function')p.catch(function(){});}else{var u=wrap.getAttribute('data-stream-host');if(u)window.open((u.replace(/\/$/,''))+'/live','_blank','noopener');}}};});grid.querySelectorAll('.camera-details-toggle').forEach(function(btn){btn.onclick=function(e){e.stopPropagation();var w=this.closest('.camera-details-wrap');if(w)w.classList.toggle('open');};});}).catch(function(){});}function fetchLog(){fetch('/api/log').then(function(r){return r.json();}).then(function(j){var tbody=el('logRows');if(!tbody)return;var entries=j.entries||[];if(!entries.length){tbody.innerHTML=LT+'tr'+'>'+LT+'td colspan="10"'+'>No log entries.'+LTS+'td>'+LTS+'tr>';return;}tbody.innerHTML=entries.slice(-50).reverse().map(function(x){var tf=x.temperature!=null?c2f(x.temperature):null;return LT+'tr'+(x.motion==1?' class="motion"':'')+'>'+LT+'td'+'>'+(x.ts_ms?new Date(x.ts_ms).toLocaleString():'-')+LTS+'td>'+LT+'td'+'>'+(x.mac||'-')+LTS+'td>'+LT+'td'+'>'+(x.label||'-')+LTS+'td>'+LT+'td'+'>'+(x.location||'indoor')+LTS+'td>'+LT+'td'+'>'+(x.motion==1?'Yes':'No')+mmwaveDesc(x)+LTS+'td>'+LT+'td'+'>'+(tf!=null?tf.toFixed(1):'-')+LTS+'td>'+LT+'td'+'>'+(x.humidity!=null?Number(x.humidity).toFixed(1):'-')+LTS+'td>'+LT+'td'+'>'+(x.pressure!=null?Number(x.pressure).toFixed(1):'-')+LTS+'td>'+LT+'td'+'>'+(gasAqi(x.gas)!=null?gasAqi(x.gas):'-')+LTS+'td>'+LTS+'tr>';}).join('');}).catch(function(){});}var bleEntries=[];var bleWhitelist=[];var bleLogSortKey='ts_ms';var bleLogSortDir=-1;function renderBleLogRows(arr){var tbody=el('bleLogRows');if(!tbody)return;if(!arr.length){tbody.innerHTML=LT+'tr'+'>'+LT+'td colspan="7"'+'>No BLE entries.'+LTS+'td>'+LTS+'tr>';return;}tbody.innerHTML=arr.map(function(x){return LT+'tr>'+LT+'td'+'>'+(x.ts_ms?new Date(x.ts_ms).toLocaleString():'-')+LTS+'td>'+LT+'td'+'>'+(x.sensor_mac||'-')+LTS+'td>'+LT+'td'+'>'+(x.label||'-')+LTS+'td>'+LT+'td'+'>'+(x.ble_mac||'-')+LTS+'td>'+LT+'td'+'>'+(x.rssi_dbm!=null?x.rssi_dbm+' dBm':'-')+LTS+'td>'+LT+'td'+'>'+(x.seen_count!=null?String(x.seen_count):'-')+LTS+'td>'+LT+'td'+'>'+(x.is_new?'Yes':'No')+LTS+'td>'+LTS+'tr>';}).join('');}function sortBleLogAndRender(){var arr=bleEntries.slice();var key=bleLogSortKey,dir=bleLogSortDir;var numKeys={ts_ms:1,rssi_dbm:1,seen_count:1};var cmp;if(numKeys[key]){cmp=function(a,b){var va=Number(a[key]);var vb=Number(b[key]);if(!isFinite(va))va=key==='rssi_dbm'?-999:0;if(!isFinite(vb))vb=key==='rssi_dbm'?-999:0;return dir*(va-vb);};}else if(key==='is_new'){cmp=function(a,b){var va=(a.is_new?1:0);var vb=(b.is_new?1:0);return dir*(va-vb);};}else{cmp=function(a,b){var va=(a[key]||'').toString();var vb=(b[key]||'').toString();return dir*va.localeCompare(vb);};}arr.sort(cmp);renderBleLogRows(arr);var tbl=el('bleLogTable');if(tbl){tbl.querySelectorAll('th.sortable').forEach(function(th){th.classList.remove('asc','desc');if(th.getAttribute('data-sort')===key)th.classList.add(dir===1?'asc':'desc');});}}function fetchBleLog(){fetch('/api/ble_log').then(function(r){return r.json();}).then(function(j){bleEntries=j.entries||[];sortBleLogAndRender();}).catch(function(){});}function fetchWifiLog(){fetch('/api/wifi_log').then(function(r){return r.json();}).then(function(j){var entries=j.entries||[];var tbody=el('wifiLogRows');if(!tbody)return;if(!entries.length){tbody.innerHTML=LT+'tr'+'>'+LT+'td colspan="7"'+'>No WiFi entries. Enable WiFi scan for a sensor above.'+LTS+'td>'+LTS+'tr>';return;}tbody.innerHTML=entries.map(function(x){return LT+'tr>'+LT+'td'+'>'+(x.ts_ms?new Date(x.ts_ms).toLocaleString():'-')+LTS+'td>'+LT+'td'+'>'+(x.sensor_mac||'-')+LTS+'td>'+LT+'td'+'>'+(x.label||'-')+LTS+'td>'+LT+'td'+'>'+esc(x.ssid||'')+LTS+'td>'+LT+'td'+'>'+(x.bssid||'-')+LTS+'td>'+LT+'td'+'>'+(x.rssi_dbm!=null?x.rssi_dbm+' dBm':'-')+LTS+'td>'+LT+'td'+'>'+(x.channel!=null?String(x.channel):'-')+LTS+'td>'+LTS+'tr>';}).join('');}).catch(function(){});}function fetchBleWhitelist(){fetch('/api/ble_whitelist').then(function(r){return r.json();}).then(function(j){bleWhitelist=j.entries||[];var tbody=el('bleWhitelistRows');if(!tbody)return;if(!bleWhitelist.length){tbody.innerHTML=LT+'tr'+'>'+LT+'td colspan="3"'+'>No whitelist.'+LTS+'td>'+LTS+'tr>';return;}tbody.innerHTML=bleWhitelist.map(function(x){return LT+'tr>'+LT+'td'+'>'+esc(x.mac)+LTS+'td>'+LT+'td'+'>'+esc(x.label)+LTS+'td>'+LT+'td'+'>'+LT+'button type="button" class="btnBleWhitelistRemove" data-mac="'+esc(x.mac)+'"'+'>Remove'+LTS+'button>'+LTS+'td>'+LTS+'tr>';}).join('');tbody.querySelectorAll('.btnBleWhitelistRemove').forEach(function(btn){btn.onclick=function(){var m=this.getAttribute('data-mac');if(!m||!confirm('Remove '+m+'?'))return;fetch('/api/ble_whitelist/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:m})}).then(function(){fetchBleWhitelist();});};});}).catch(function(){});}function buildDailyTodo(nodes){var list=el('dailyTodoList');if(!list)return;var tasks=[],i,n,lbl,hum;var plantNodes=nodes.filter(function(n){if(!n||!n.mac)return false;var l=(n.label||'').toLowerCase();var isTank=l.indexOf('tank')>=0||l.indexOf('aquarium')>=0||l.indexOf('fish')>=0;var hasTankData=(n.temperature_water!=null&&isFinite(n.temperature_water)&&n.temperature_water>-500)||(n.tds_ppm!=null&&isFinite(n.tds_ppm)&&n.tds_ppm>=0);if(isTank||hasTankData)return false;var chs=moistureChannels(n.moisture);for(var ci=0;ci<chs.length;ci++){if(chs[ci]!=null)return true;}return false;});for(i=0;i<plantNodes.length;i++){n=plantNodes[i];lbl=esc(n.label||n.mac);var chs=moistureChannels(n.moisture),dryCount=0;for(var ci=0;ci<chs.length;ci++){if(chs[ci]!=null&&chs[ci]<25)dryCount++;}if(dryCount>0)tasks.push({text:'Water '+lbl+' ('+dryCount+' dry)',type:'plant'});else tasks.push({text:'Check '+lbl,type:'plant'});}var tankNodes=nodes.filter(function(n){if(!n||!n.mac)return false;var l=(n.label||'').toLowerCase();var isTankLabel=l.indexOf('tank')>=0||l.indexOf('aquarium')>=0||l.indexOf('fish')>=0;var hasTankData=(n.temperature_water!=null&&isFinite(n.temperature_water)&&n.temperature_water>-500)||(n.tds_ppm!=null&&isFinite(n.tds_ppm)&&n.tds_ppm>=0);return isTankLabel||hasTankData;});var tankNamesSeen={};for(i=0;i<tankNodes.length;i++){n=tankNodes[i];var tname=(n.label||n.mac||'').trim();if(!tankNamesSeen[tname]){tankNamesSeen[tname]=true;lbl=esc(n.label||n.mac);tasks.push({text:'Check '+lbl,type:'tank'});}}if(!tasks.length){list.innerHTML=LT+'li class="daily-todo-item"'+'>No plants or tanks need attention today'+LTS+'li>';return;}list.innerHTML=tasks.map(function(t){return LT+'li class="daily-todo-item daily-todo-item--'+(t.type||'')+'"'+'>'+t.text+LTS+'li>';}).join('');}function plantLabelForChannel(n,ci){var pl=n.plant_labels;if(pl&&Array.isArray(pl)&&pl[ci]&&pl[ci].length>0)return pl[ci];return'';}function fetchPlantDashboard(){fetch('/api/sensors').then(function(r){return r.json();}).then(function(j){var nodes=j.nodes||[],grid=el('plantSensorCards');if(!grid)return;var plantNodes=[],totalPlants=0,needWater=0,sumM=0,countM=0;for(var i=0;i<nodes.length;i++){var n=nodes[i];if(!n||!n.mac)continue;var l=(n.label||'').toLowerCase();var isTank=l.indexOf('tank')>=0||l.indexOf('aquarium')>=0||l.indexOf('fish')>=0;var hasTankData=(n.temperature_water!=null&&isFinite(n.temperature_water)&&n.temperature_water>-500)||(n.tds_ppm!=null&&isFinite(n.tds_ppm)&&n.tds_ppm>=0);if(isTank||hasTankData)continue;var chs=moistureChannels(n.moisture),hasPlant=false;for(var ci=0;ci<chs.length;ci++){if(chs[ci]!=null){hasPlant=true;totalPlants++;sumM+=chs[ci];countM++;if(chs[ci]<25)needWater++;}}if(hasPlant)plantNodes.push(n);}setText('plantSummaryCount',totalPlants);setText('plantSummaryNeedsWater',needWater);setText('plantSummaryAvgMoisture',countM>0?Math.round(sumM/countM)+'%':'-');var html=[];for(var i=0;i<plantNodes.length;i++){var n=plantNodes[i],lbl=esc(n.label||n.mac),chs=moistureChannels(n.moisture);var tF=n.temperature!=null&&isFinite(n.temperature)?c2f(n.temperature):null;var hT=n.humidity!=null?Number(n.humidity).toFixed(1):'-';var bars='',alerts='',dryCount=0;for(var ci=0;ci<chs.length;ci++){if(chs[ci]!=null){bars+=moistureBarHtml(ci,chs[ci],plantLabelForChannel(n,ci),n.mac);if(chs[ci]<25)dryCount++;}}if(dryCount>0)alerts=LT+'div class="plant-alert"'+'>'+dryCount+(dryCount===1?' plant':' plants')+' need water'+LTS+'div>';var hasTemp=tF!=null&&isFinite(tF);var hasHum=n.humidity!=null&&isFinite(n.humidity);var hasUp=n.uptime_ms!=null&&n.uptime_ms!==undefined;var ambientParts=[];if(hasTemp)ambientParts.push(LT+'span'+'>'+tF.toFixed(1)+' F'+LTS+'span>');if(hasHum)ambientParts.push(LT+'span'+'>'+Number(n.humidity).toFixed(1)+'% RH'+LTS+'span>');if(hasUp)ambientParts.push(LT+'span'+'>'+fmtUp(n.uptime_ms)+LTS+'span>');var ambientHtml=ambientParts.length?LT+'div class="plant-ambient"'+'>'+ambientParts.join('')+LTS+'div>':'';html.push(LT+'div class="plant-card" data-mac="'+n.mac+'"'+'>'+LT+'h4 class="plant-card-title plant-card-title-editable" title="Click to edit"'+'>'+lbl+LTS+'h4>'+LT+'div class="plant-card-mac"'+'>'+n.mac+LTS+'div>'+LT+'div class="plant-bars"'+'>'+bars+LTS+'div>'+alerts+ambientHtml+LTS+'div>');}grid.innerHTML=html.length?html.join(''):LT+'p class="muted" style="padding:16px;text-align:center"'+'>No moisture sensors detected. Connect a Grove soil sensor to a C6 unit.'+LTS+'p>';grid.querySelectorAll('.plant-label-editable').forEach(function(el){el.onclick=function(){var mac=this.getAttribute('data-mac'),ch=Number(this.getAttribute('data-ch')),cur=this.textContent||'';var newLabel=prompt('Name for Plant '+(ch+1)+' on '+mac+':',cur);if(newLabel===null)return;fetch('/api/plant_label',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:mac,channel:ch,label:newLabel.trim()})}).then(function(){setTimeout(fetchPlantDashboard,500);});};});grid.querySelectorAll('.plant-card-title-editable').forEach(function(h){h.onclick=function(){var card=this.closest('.plant-card');if(!card)return;var mac=card.getAttribute('data-mac');var cur=(this.textContent||'').trim();var newLabel=prompt('Rename sensor:',cur);if(newLabel===null)return;fetch('/api/labels',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:mac,label:newLabel.trim()})}).then(function(){fetchPlantDashboard();});};});}).catch(function(){var g=el('plantSensorCards');if(g)g.innerHTML=LT+'p class="muted"'+'>Could not load sensors.'+LTS+'p>';});}function fetchFishTankDashboard(){fetch('/api/sensors').then(function(r){return r.json();}).then(function(j){var nodes=j.nodes||[];var tankNodes=nodes.filter(function(n){if(!n||!n.mac)return false;var l=(n.label||'').toLowerCase();var isTankLabel=l.indexOf('tank')>=0||l.indexOf('aquarium')>=0||l.indexOf('fish')>=0;var hasTankData=(n.temperature_water!=null&&isFinite(n.temperature_water)&&n.temperature_water>-500)||(n.tds_ppm!=null&&isFinite(n.tds_ppm)&&n.tds_ppm>=0);return isTankLabel||hasTankData;});var byName={},tankName,n,i,nodesList;for(i=0;i<tankNodes.length;i++){n=tankNodes[i];tankName=(n.label||n.mac||'').trim();if(!byName[tankName])byName[tankName]=[];byName[tankName].push(n);}var tankNames=Object.keys(byName).sort();if(tankNames.length===0){_tankOverviewStatus='-';_tankOverviewTemp='-';}else if(tankNames.length===1){_tankOverviewStatus='OK';nodesList=byName[tankNames[0]];var ft=null;for(i=0;i<nodesList.length;i++){var nn=nodesList[i];var tw=nn.temperature_water!=null&&isFinite(nn.temperature_water)&&nn.temperature_water>-500?c2f(nn.temperature_water):null;var t=nn.temperature!=null&&isFinite(nn.temperature)?c2f(nn.temperature):null;var v=tw!=null?tw:t;if(v!=null){ft=v.toFixed(1);break;}}_tankOverviewTemp=ft!=null?ft+'F':'-';}else{_tankOverviewStatus=tankNames.length+' tanks';_tankOverviewTemp='-';}setText('overviewTankStatus',_tankOverviewStatus);setText('overviewTankTemp',_tankOverviewTemp);if(el('overview')&&el('overview').classList.contains('active'))renderOverview();var wrap=el('fishtankTanksWrap');if(!wrap)return;if(tankNames.length===0){wrap.innerHTML=LT+'p class="muted" style="padding:12px"'+'>No tank sensors. Use a label containing "tank" or "aquarium", or connect a DS18B20 temperature probe (it will appear here automatically).'+LTS+'p>';return;}var blocks=[];for(var ti=0;ti<tankNames.length;ti++){tankName=tankNames[ti];nodesList=byName[tankName];var firstTemp=null;for(i=0;i<nodesList.length;i++){var nn=nodesList[i];var tw=nn.temperature_water!=null&&isFinite(nn.temperature_water)&&nn.temperature_water>-500?c2f(nn.temperature_water):null;var t=nn.temperature!=null&&isFinite(nn.temperature)?c2f(nn.temperature):null;var v=tw!=null?tw:t;if(v!=null){firstTemp=v.toFixed(1);break;}}var firstTds=null;for(i=0;i<nodesList.length;i++){var nn=nodesList[i];if(nn.tds_ppm!=null&&isFinite(nn.tds_ppm)&&nn.tds_ppm>=0){firstTds=Number(nn.tds_ppm).toFixed(0);break;}}var summaryHtml=LT+'div class="fishtank-summary"'+'>'+LT+'div class="summary-card"'+'>'+LT+'div class="summary-title"'+'>Tank status'+LTS+'div>'+LT+'div class="summary-value"'+'>OK'+LTS+'div>'+LT+'div class="summary-sub"'+'>Placeholder'+LTS+'div>'+LTS+'div>'+LT+'div class="summary-card"'+'>'+LT+'div class="summary-title"'+'>Water temp'+LTS+'div>'+LT+'div class="summary-value"'+'>'+(firstTemp!=null?firstTemp+'F':'-')+LTS+'div>'+LT+'div class="summary-sub"'+'>F from sensor'+LTS+'div>'+LTS+'div>'+LT+'div class="summary-card"'+'>'+LT+'div class="summary-title"'+'>TDS (ppm)'+LTS+'div>'+LT+'div class="summary-value"'+'>'+(firstTds!=null?firstTds:'-')+LTS+'div>'+LT+'div class="summary-sub"'+'>from sensor'+LTS+'div>'+LTS+'div>'+LT+'div class="summary-card"'+'>'+LT+'div class="summary-title"'+'>pH'+LTS+'div>'+LT+'div class="summary-value"'+'>-'+LTS+'div>'+LT+'div class="summary-sub"'+'>Placeholder'+LTS+'div>'+LTS+'div>'+LT+'div class="summary-card"'+'>'+LT+'div class="summary-title"'+'>Level'+LTS+'div>'+LT+'div class="summary-value"'+'>-'+LTS+'div>'+LT+'div class="summary-sub"'+'>Placeholder'+LTS+'div>'+LTS+'div>'+LTS+'div>';var cardsHtml=[];for(i=0;i<nodesList.length;i++){n=nodesList[i];var lbl=esc(n.label||n.mac);var waterF=n.temperature_water!=null&&isFinite(n.temperature_water)&&n.temperature_water>-500?c2f(n.temperature_water):null;var airF=n.temperature!=null&&isFinite(n.temperature)?c2f(n.temperature):null;var hT=n.humidity!=null?Number(n.humidity).toFixed(1):'-';var waterRow=LT+'div class="row"'+'>'+LT+'span class="k"'+'>Water temp (F)'+LTS+'span>'+LT+'span class="v"'+'>'+((waterF!=null)?waterF.toFixed(1):(airF!=null)?airF.toFixed(1):'-')+LTS+'span>'+LTS+'div>';var airRow=(airF!=null&&waterF!=null)?LT+'div class="row"'+'>'+LT+'span class="k"'+'>Air temp (F)'+LTS+'span>'+LT+'span class="v"'+'>'+airF.toFixed(1)+LTS+'span>'+LTS+'div>':'';var tdsRow=(n.tds_ppm!=null&&isFinite(n.tds_ppm)&&n.tds_ppm>=0)?LT+'div class="row"'+'>'+LT+'span class="k"'+'>TDS (ppm)'+LTS+'span>'+LT+'span class="v"'+'>'+Number(n.tds_ppm).toFixed(0)+LTS+'span>'+LTS+'div>':'';cardsHtml.push(LT+'div class="sensor-card" data-mac="'+n.mac+'"'+'>'+LT+'h4'+'>'+LT+'span class="sensor-title"'+'>'+lbl+LTS+'span>'+LTS+'h4>'+LT+'div class="mac"'+'>'+n.mac+LTS+'div>'+waterRow+airRow+tdsRow+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Ambient H (%)'+LTS+'span>'+LT+'span class="v"'+'>'+hT+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>pH'+LTS+'span>'+LT+'span class="v"'+'>-'+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Water level'+LTS+'span>'+LT+'span class="v"'+'>-'+LTS+'span>'+LTS+'div>'+LTS+'div>');}blocks.push(LT+'div class="fishtank-tank-block"'+'>'+LT+'h3 class="fishtank-section-title"'+'>'+esc(tankName)+LTS+'h3>'+summaryHtml+LT+'div class="fishtank-section"'+'>'+LT+'h3 class="fishtank-section-title"'+'>Tank sensors'+LTS+'h3>'+LT+'div class="fishtank-cards-wrap"'+'>'+cardsHtml.join('')+LTS+'div>'+LTS+'div>'+LTS+'div>');}wrap.innerHTML=blocks.join('');}).catch(function(){var wrap=el('fishtankTanksWrap');if(wrap)wrap.innerHTML=LT+'p class="muted"'+'>Could not load sensors.'+LTS+'p>';});}function renderOverview(){var o=el('overview');if(!o||!o.classList.contains('active'))return;var h=el('halowStatus'),heap=el('statHeapPct'),wifi=el('wifi2gBackhaul'),mt=el('motionSummaryTotal'),ma=el('motionSummaryActive'),ml=el('motionSummaryLast'),nodes=el('statNodes'),cam=el('statCameras'),et=el('motionSummaryEnvTemp'),eh=el('motionSummaryEnvHum'),ea=el('motionSummaryEnvAqi'),ep=el('motionSummaryEnvPressure'),pc=el('plantSummaryCount'),pw=el('plantSummaryNeedsWater'),lr=el('logRows'),br=el('bleWhitelistRows'),wr=el('wifiLogRows');setText('overviewHalow',h?h.textContent:'-');setText('overviewHeap',heap?heap.textContent:'-');setText('overviewWifi',wifi?wifi.textContent:'-');var rssiT=el('halowTopRssiText'),rssiW=el('wifiTopRssiText'),ipH=el('halowTopIp'),ipW=el('wifiTopIp');if(rssiT)rssiT.textContent=(el('halowRssiDbm')||{}).textContent||(el('wifi2gStaRssiDbm')||{}).textContent||'- dBm';if(rssiW)rssiW.textContent=(el('wifi2gStaRssiDbm')||{}).textContent||'- dBm';if(ipH)ipH.textContent=(el('halowIpCollapsed')&&el('halowIpCollapsed').textContent)?el('halowIpCollapsed').textContent:'IP: -';if(ipW)ipW.textContent='IP: '+(el('wifi2gStaIp')?el('wifi2gStaIp').textContent.replace(/^IP: /,'')||'-':'-');var pctH=el('halowTopRssiFill'),pctW=el('wifiTopRssiFill');if(pctH){var db=el('halowRssiDbm');var t=db?db.textContent:'';var num=parseFloat(t);var p=wifiRssiPct(isFinite(num)?num:null);pctH.style.width=(p!=null?p:0)+'%';}if(pctW){var db2=el('wifi2gStaRssiDbm');var t2=db2?db2.textContent:'';var num2=parseFloat(t2);var p2=wifiRssiPct(isFinite(num2)?num2:null);pctW.style.width=(p2!=null?p2:0)+'%';}setText('overviewMotionTotal',mt?mt.textContent:'-');setText('overviewMotionActive',ma?ma.textContent:'-');setText('overviewMotionLast',ml?ml.textContent:'-');setText('overviewNodes',nodes?nodes.textContent:'-');setText('overviewCameras',cam?cam.textContent:'-');var indEl=el('overviewEnvIndoor'),outEl=el('overviewEnvOutdoor'),indSub=el('overviewEnvIndoorSub'),outSub=el('overviewEnvOutdoorSub'),mi=el('motionSummaryIndoor'),mo=el('motionSummaryOutdoor'),mis=el('motionSummaryIndoorSub'),mos=el('motionSummaryOutdoorSub');if(indEl)indEl.textContent=mi?mi.textContent:'-';if(outEl)outEl.textContent=mo?mo.textContent:'-';if(indSub)indSub.textContent=mis?mis.textContent:'0 sensors';if(outSub)outSub.textContent=mos?mos.textContent:'0 sensors';setText('overviewPlantCount',pc?pc.textContent:'-');setText('overviewPlantWater',pw?pw.textContent:'-');var pam=el('plantSummaryAvgMoisture');setText('overviewPlantAvgMoisture',pam?pam.textContent:'-');setText('overviewTankStatus',_tankOverviewStatus);setText('overviewTankTemp',_tankOverviewTemp);var logEl=el('overviewLogCount');if(logEl)logEl.textContent=lr&&lr.querySelectorAll('tr').length?lr.querySelectorAll('tr').length+' entries':'View log';var bleEl=el('overviewBleCount');if(bleEl)bleEl.textContent=br&&br.querySelectorAll('tr').length?String(br.querySelectorAll('tr').length):'-';var wifiLogEl=el('overviewWifiLogCount');if(wifiLogEl)wifiLogEl.textContent=wr&&wr.querySelectorAll('tr').length?String(wr.querySelectorAll('tr').length):'-';}function activateTab(tid){showTab(tid);if(tid==='overview'){fetchDebug();fetchHalow();fetchWifi2g();fetchSensors();fetchPlantDashboard();fetchFishTankDashboard();fetchLog();fetchBleWhitelist();fetchWifiLog();setTimeout(renderOverview,50);}if(tid==='log')fetchLog();if(tid==='ble_log'){fetchSensors();fetchBleLog();fetchBleWhitelist();}if(tid==='wifi_log'){fetchSensors();fetchWifiLog();}if(tid==='motion'||tid==='sensors'||tid==='garden'||tid==='video')fetchSensors();if(tid==='garden')renderGarden();if(tid==='video')renderVideo();if(tid==='plant'){fetchPlantDashboard();if(typeof window.renderPlantGraph==='function')window.renderPlantGraph();}if(tid==='fishtank')fetchFishTankDashboard();if(tid==='system'){fetchDebug();fetchHalow();fetchWifi2g();}}document.body.addEventListener('click',function(e){var t=e.target.closest('.tabs button');if(t){var id=t.getAttribute('data-tab');if(id)activateTab(id);return;}var g=e.target.closest('.overview-goto');if(g){var id=g.getAttribute('data-goto-tab');if(id)activateTab(id);}});document.querySelectorAll('.tabs button').forEach(function(b){b.onclick=function(){activateTab(this.getAttribute('data-tab'));};});document.querySelectorAll('.overview-goto').forEach(function(btn){btn.onclick=function(){var t=this.getAttribute('data-goto-tab');if(t)activateTab(t);};});if(el('topMotionCard')){el('topMotionCard').onclick=function(){activateTab('motion');};el('topMotionCard').onkeydown=function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();activateTab('motion');}};}document.querySelectorAll('.card-toggle').forEach(function(b){b.onclick=function(e){e.stopPropagation();var c=this.closest('.collapsible');if(c)c.classList.toggle('open');};});document.querySelectorAll('.halow-card.collapsible').forEach(function(c){c.onclick=function(e){if(e.target.closest('button'))return;this.classList.toggle('open');};});if(el('labelEditSave'))el('labelEditSave').onclick=saveLabel;if(el('labelEditCancel'))el('labelEditCancel').onclick=function(){editingMac=null;el('labelEditForm').classList.remove('show');};if(el('btnHalowReconnect'))el('btnHalowReconnect').onclick=function(){var st=el('halowReconnectStatus');if(st)st.textContent='Reconnecting...';fetch('/api/halow/reconnect',{method:'POST'}).then(function(r){return r.json();}).then(function(j){if(st)st.textContent=(j&&j.ok)?'OK':'Failed';setTimeout(function(){if(st)st.textContent='';},2000);});};if(el('btnClearLog'))el('btnClearLog').onclick=function(){if(confirm('Clear log?'))fetch('/api/log/clear',{method:'POST'}).then(fetchLog);};if(el('btnClearBleLog'))el('btnClearBleLog').onclick=function(){if(confirm('Clear BLE log?'))fetch('/api/ble_log/clear',{method:'POST'}).then(fetchBleLog);};if(el('btnClearWifiLog'))el('btnClearWifiLog').onclick=function(){if(confirm('Clear WiFi log?'))fetch('/api/wifi_log/clear',{method:'POST'}).then(fetchWifiLog);};if(el('btnWifiLogEnable'))el('btnWifiLogEnable').onclick=function(){var sel=el('wifiLogSensor'),st=el('wifiLogStatus');var mac=sel?sel.value:'';if(!mac){if(st)st.textContent='Select a sensor';return;}if(st)st.textContent='Enabling...';fetch('/api/wifi_log/enable',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:mac,enabled:true})}).then(function(r){return r.json();}).then(function(j){if(st){st.textContent=(j&&j.ok)?'Enabled':'Failed';setTimeout(function(){if(st)st.textContent='';},2500);}});};if(el('btnWifiLogDisable'))el('btnWifiLogDisable').onclick=function(){var sel=el('wifiLogSensor'),st=el('wifiLogStatus');var mac=sel?sel.value:'';if(!mac){if(st)st.textContent='Select a sensor';return;}if(st)st.textContent='Disabling...';fetch('/api/wifi_log/enable',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:mac,enabled:false})}).then(function(r){return r.json();}).then(function(j){if(st){st.textContent=(j&&j.ok)?'Disabled':'Failed';setTimeout(function(){if(st)st.textContent='';},2500);}});};if(el('btnBleWhitelist'))el('btnBleWhitelist').onclick=function(){var st=el('bleWhitelistStatus');if(st)st.textContent='Capturing...';fetch('/api/ble_whitelist/capture',{method:'POST'}).then(function(r){return r.json();}).then(function(j){fetchBleWhitelist();var st=el('bleWhitelistStatus');if(st){st.textContent=(j&&j.ok)?'Captured '+(j.count!=null?j.count:'')+' devices':'Failed';setTimeout(function(){if(st)st.textContent='';},2500);}});};if(el('btnBleWhitelistClear'))el('btnBleWhitelistClear').onclick=function(){var st=el('bleWhitelistStatus');if(st)st.textContent='Clearing...';fetch('/api/ble_whitelist/clear',{method:'POST'}).then(function(){fetchBleWhitelist();if(st){st.textContent='Cleared';setTimeout(function(){if(st)st.textContent='';},2500);}});};if(el('btnBleWhitelistAdd'))el('btnBleWhitelistAdd').onclick=function(){var macEl=el('bleWhitelistMac'),lblEl=el('bleWhitelistLabel'),st=el('bleWhitelistStatus');var mac=macEl?macEl.value.trim():'',lbl=lblEl?lblEl.value.trim():'';if(!mac){if(st)st.textContent='Enter BLE MAC';return;}if(st)st.textContent='Adding...';fetch('/api/ble_whitelist',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:mac,label:lbl})}).then(function(r){return r.json();}).then(function(j){if(st)st.textContent=(j&&j.ok)?'Added':'Failed';fetchBleWhitelist();setTimeout(function(){if(st)st.textContent='';},2500);}).catch(function(){if(st){st.textContent='Failed';setTimeout(function(){if(st)st.textContent='';},2500);}});};document.querySelectorAll('#bleLogTable th.sortable').forEach(function(th){th.onclick=function(){var key=this.getAttribute('data-sort');if(!key)return;if(bleLogSortKey===key){bleLogSortDir=-bleLogSortDir;}else{bleLogSortKey=key;bleLogSortDir=1;}sortBleLogAndRender();};});fetch('/api/ui_skin').then(function(r){return r.json();}).then(function(j){if(j&&j.skin)document.body.setAttribute('data-skin',j.skin);var fs=(j&&j.font_size)||'medium';document.body.setAttribute('data-font-size',fs);}).catch(function(){});fetchDebug();fetchSensors();fetchHalow();fetchWifi2g();setInterval(fetchSensors,4000);setInterval(fetchDebug,10000);setInterval(fetchHalow,10000);setInterval(fetchWifi2g,10000);setInterval(function(){var p=el('plant');if(p&&p.classList.contains('active')){fetchPlantDashboard();if(typeof window.renderPlantGraph==='function')window.renderPlantGraph();}},4000);(function(){var envSelectedMac='all';var envNodes=[];var envEntries=[];var envFiltered=[];var envVisible={temp:true,hum:true,aqi:true,pressure:true};try{var _c=localStorage.getItem('sensor_net_env_cache');if(_c){var _e=JSON.parse(_c);if(Array.isArray(_e)&&_e.length){envEntries=_e;}}var _sm=localStorage.getItem('sensor_net_env_selected');if(_sm)envSelectedMac=_sm;var _ev=localStorage.getItem('sensor_net_env_visible');if(_ev){var _evj=JSON.parse(_ev);if(_evj&&typeof _evj==='object')envVisible=_evj;} }catch(e){}function envAqi(g){if(g==null||g==='')return null;var x=Number(g);if(!isFinite(x))return null;if(0>=x)return 500;if(x>=300)return 0;return Math.round(Math.max(0,Math.min(500,(300-x)/300*500)));}function envFmtF(c){var x=Number(c);if(!isFinite(x))return null;return x*9/5+32;}function envDraw(entries){var cv=el('envGraph'),timeEl=el('envGraphTime');if(!cv)return;var ctx=cv.getContext('2d');if(!ctx)return;var wrap=cv.parentElement;if(wrap&&wrap.clientWidth>0&&wrap.clientHeight>0){var dw=wrap.clientWidth,dh=wrap.clientHeight;if(cv.width!==dw||cv.height!==dh){cv.width=dw;cv.height=dh;}}var w=cv.width,h=cv.height,p=20,axisColor=document.body.getAttribute('data-skin')==='rwb'?'#0f172a':'rgba(154,255,197,0.9)';ctx.clearRect(0,0,w,h);if(timeEl)timeEl.textContent='';if(!entries||!entries.length){ctx.fillStyle=axisColor;ctx.font='12px Consolas, monospace';ctx.fillText('No environmental data in log yet',24,Math.round(h/2));return;}var s=entries.slice().sort(function(a,b){return Number(a.ts_ms||0)-Number(b.ts_ms||0);});var maxTs=s.length?Math.max.apply(null,s.map(function(e){return Number(e.ts_ms||0);})):0;var sixHoursMs=21600000;var cutoff=(maxTs>1e12)?(Date.now()-sixHoursMs):(maxTs-sixHoursMs);s=s.filter(function(e){return Number(e.ts_ms||0)>=cutoff;});if(!s.length&&entries.length>0){cutoff=maxTs-sixHoursMs;s=entries.slice().sort(function(a,b){return Number(a.ts_ms||0)-Number(b.ts_ms||0);});s=s.filter(function(e){return Number(e.ts_ms||0)>=cutoff;});}if(!s.length){ctx.fillStyle=axisColor;ctx.font='12px Consolas, monospace';ctx.fillText('No data in the last 6 hours',24,Math.round(h/2));return;}var tv=[],hv=[],av=[],pv=[],i,v;for(i=0;s.length>i;i++){v=s[i];if(v.temperature!=null&&isFinite(v.temperature))tv.push(envFmtF(v.temperature));if(v.humidity!=null&&isFinite(v.humidity))hv.push(Number(v.humidity));var a=envAqi(v.gas);if(a!=null)av.push(a);if(v.pressure!=null&&isFinite(v.pressure))pv.push(Number(v.pressure));}function rr(vals,dn,dx){if(!vals.length)return {min:dn,max:dx};var mn=Math.min.apply(null,vals),mx=Math.max.apply(null,vals);if(mn===mx){mn-=1;mx+=1;}return {min:mn,max:mx};}var tr=rr(tv,60,85),hr=rr(hv,20,90),ar=rr(av,0,500),pr=rr(pv,900,1100),leftPad=70,pad=20,rightPad=72,x0=leftPad,y0=pad,x1=w-rightPad,y1=h-pad;ctx.strokeStyle='rgba(54,255,122,0.2)';ctx.lineWidth=1;for(i=0;4>=i;i++){var gy=y0+((y1-y0)*i/4);ctx.beginPath();ctx.moveTo(x0,gy);ctx.lineTo(x1,gy);ctx.stroke();}var firstR=null,firstUnit='';if(envVisible.temp){firstR=tr;firstUnit=' F';}else if(envVisible.hum){firstR=hr;firstUnit='%';}else if(envVisible.aqi){firstR=ar;firstUnit='';}else if(envVisible.pressure){firstR=pr;firstUnit=' hPa';}ctx.fillStyle=axisColor;ctx.font='10px Consolas, monospace';ctx.textAlign='right';ctx.textBaseline='middle';for(i=0;i<=4;i++){var gy=y0+((y1-y0)*i/4);var val=firstR?firstR.max-(firstR.max-firstR.min)*i/4:(100-i*25);var txt=firstR?((firstUnit===' F'||firstUnit==='%')?val.toFixed(1):Math.round(val).toString())+firstUnit:(100-i*25).toString();ctx.fillText(txt,x0-4,gy);}ctx.textAlign='left';ctx.textBaseline='alphabetic';function line(k,color,r,xf){var started=false;ctx.strokeStyle=color;ctx.lineWidth=2;ctx.beginPath();for(i=0;s.length>i;i++){var e=s[i];var xv=x0+((x1-x0)*i/Math.max(1,s.length-1));var raw=k==='aqi'?envAqi(e.gas):e[k];if(raw==null||!isFinite(raw)){started=false;continue;}var val=xf?xf(raw):Number(raw);var y=y1-((val-r.min)/(r.max-r.min))*(y1-y0);if(!started){ctx.moveTo(xv,y);started=true;}else ctx.lineTo(xv,y);}ctx.stroke();}if(envVisible.temp)line('temperature','#00fff9',tr,envFmtF);if(envVisible.hum)line('humidity','#ff00aa',hr,null);if(envVisible.aqi)line('aqi','#ffd166',ar,null);if(envVisible.pressure)line('pressure','#4dabff',pr,null);var last=s[s.length-1];if(last){var endLabels=[];if(envVisible.temp){var v=envFmtF(last.temperature);if(v!=null)endLabels.push({y:y1-((v-tr.min)/(tr.max-tr.min))*(y1-y0),txt:v.toFixed(1)+'F',color:'#00fff9'});}if(envVisible.hum&&last.humidity!=null){var v=Number(last.humidity);endLabels.push({y:y1-((v-hr.min)/(hr.max-hr.min))*(y1-y0),txt:v.toFixed(1)+'%',color:'#ff00aa'});}if(envVisible.aqi){var v=envAqi(last.gas);if(v!=null)endLabels.push({y:y1-((v-ar.min)/(ar.max-ar.min))*(y1-y0),txt:String(v),color:'#ffd166'});}if(envVisible.pressure&&last.pressure!=null){var v=Number(last.pressure);endLabels.push({y:y1-((v-pr.min)/(pr.max-pr.min))*(y1-y0),txt:v.toFixed(1)+' hPa',color:'#4dabff'});}endLabels.sort(function(a,b){return a.y-b.y;});var minGap=14;for(var j=1;j<endLabels.length;j++){if(endLabels[j].y-endLabels[j-1].y<minGap)endLabels[j].y=Math.min(endLabels[j-1].y+minGap,y1);}for(j=endLabels.length-1;j>=1;j--){if(endLabels[j-1].y+minGap>endLabels[j].y)endLabels[j-1].y=Math.max(endLabels[j].y-minGap,y0);}ctx.font='10px Consolas, monospace';ctx.textAlign='left';ctx.textBaseline='middle';for(j=0;j<endLabels.length;j++){ctx.fillStyle=endLabels[j].color;ctx.fillText(endLabels[j].txt,x1+6,endLabels[j].y);}}var minTsEnv=s.length?Number(s[0].ts_ms||0):0;ctx.fillStyle=axisColor;ctx.font='10px Consolas, monospace';ctx.textBaseline='top';for(var xi=0;xi<=4;xi++){var xPos=x0+(x1-x0)*xi/4,t=new Date(minTsEnv+(maxTs-minTsEnv)*xi/4);ctx.textAlign=xi===0?'left':(xi===4?'right':'center');ctx.fillText(t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),xPos,y1+4);}if(timeEl)timeEl.textContent='Last 6h - '+new Date(minTsEnv).toLocaleTimeString()+' - '+new Date(maxTs).toLocaleTimeString();}function envRender(){var cardWrap=el('envSensorCards'),btnWrap=el('envSensorList'),labelEl=el('envGraphLabel');if(!cardWrap||!btnWrap)return;var map={},order=[],i,n;function hasEnvData(x){if(!x)return false;var t=x.temperature;if(t!=null&&isFinite(t)&&t>=-50&&t<=120)return true;var h=x.humidity;if(h!=null&&isFinite(h)&&h>0&&h<=100)return true;var g=x.gas;if(g!=null&&g!==''&&isFinite(Number(g)))return true;var p=x.pressure;if(p!=null&&isFinite(p)&&p>=200&&p<=1500)return true;return false;}for(i=0;envNodes.length>i;i++){n=envNodes[i];if(!n||!n.mac||!hasEnvData(n))continue;map[n.mac]=n;order.push(n.mac);}for(i=0;envEntries.length>i;i++){n=envEntries[i];if(!n||!n.mac||map[n.mac]||!hasEnvData(n))continue;map[n.mac]=n;order.push(n.mac);}if(!order.length){btnWrap.innerHTML='';cardWrap.innerHTML=LT+'p class="muted" style="padding:12px"'+'>No sensors with environmental data yet.'+LTS+'p>';if(labelEl)labelEl.textContent='All sensors';envDraw([]);return;}if('all'!==envSelectedMac&&!map[envSelectedMac])envSelectedMac='all';var b=[LT+'button type="button" class="env-sensor-btn'+('all'===envSelectedMac?' active':'')+'" data-mac="all"'+'>All sensors'+LTS+'button>'];for(i=0;order.length>i;i++){var mac=order[i],sn=map[mac],name=esc(sn.label||sn.mac||mac);b.push(LT+'button type="button" class="env-sensor-btn'+(envSelectedMac===mac?' active':'')+'" data-mac="'+mac+'"'+'>'+name+LTS+'button>');}btnWrap.innerHTML=b.join('');btnWrap.querySelectorAll('.env-sensor-btn').forEach(function(x){x.onclick=function(){envSelectedMac=this.getAttribute('data-mac')||'all';try{localStorage.setItem('sensor_net_env_selected',envSelectedMac);}catch(e){};envRender();};});var cards=[];for(i=0;order.length>i;i++){var m=order[i],s=map[m],t=envFmtF(s.temperature),h=s.humidity!=null?Number(s.humidity).toFixed(1):'-',aq=envAqi(s.gas),pr=s.pressure!=null&&isFinite(s.pressure)?Number(s.pressure).toFixed(1):'-',lab=esc(s.label||s.mac||m);cards.push(LT+'div class="sensor-card'+(envSelectedMac===m?' selected':'')+'" data-mac="'+m+'"'+'>'+LT+'h4'+'>'+LT+'span class="sensor-title"'+'>'+lab+LTS+'span>'+LTS+'h4>'+LT+'div class="mac"'+'>'+(s.mac||m)+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Air temp (F)'+LTS+'span>'+LT+'span class="v"'+'>'+((t!=null)?t.toFixed(1):'-')+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>H (%)'+LTS+'span>'+LT+'span class="v"'+'>'+h+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>AQI'+LTS+'span>'+LT+'span class="v"'+'>'+(aq!=null?aq:'-')+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>P (hPa)'+LTS+'span>'+LT+'span class="v"'+'>'+pr+LTS+'span>'+LTS+'div>'+LT+'div class="row"'+'>'+LT+'span class="k"'+'>Uptime'+LTS+'span>'+LT+'span class="v"'+'>'+(s.uptime_ms!=null?fmtUp(s.uptime_ms):'-')+LTS+'span>'+LTS+'div>'+LTS+'div>');}cardWrap.innerHTML=cards.join('');cardWrap.querySelectorAll('.sensor-card').forEach(function(c){c.onclick=function(){envSelectedMac=this.getAttribute('data-mac')||'all';try{localStorage.setItem('sensor_net_env_selected',envSelectedMac);}catch(e){};envRender();};});var filtered=envEntries.filter(function(e){if(!e)return false;if(!hasEnvData(e))return false;return 'all'===envSelectedMac||e.mac===envSelectedMac;});if(labelEl){if('all'===envSelectedMac)labelEl.textContent='All sensors';else{var cur=map[envSelectedMac];labelEl.textContent=cur?(cur.label||cur.mac||envSelectedMac):envSelectedMac;}}envFiltered=filtered;envDraw(filtered);document.querySelectorAll('.graph-legend-btn').forEach(function(btn){var series=btn.getAttribute('data-series');if(!series)return;btn.classList.toggle('off',!envVisible[series]);btn.onclick=function(){envVisible[series]=!envVisible[series];btn.classList.toggle('off',!envVisible[series]);try{localStorage.setItem('sensor_net_env_visible',JSON.stringify(envVisible));}catch(e){};envDraw(envFiltered);};});}function fetchEnvHistory(){Promise.all([fetch('/api/sensors').then(function(r){return r.json();}).catch(function(){return {nodes:[]};}),fetch('/api/log').then(function(r){return r.json();}).catch(function(){return {entries:[]};})]).then(function(rs){envNodes=rs[0]&&rs[0].nodes?rs[0].nodes:[];envEntries=rs[1]&&rs[1].entries?rs[1].entries:[];try{localStorage.setItem('sensor_net_env_cache',JSON.stringify(envEntries));localStorage.setItem('sensor_net_env_selected',envSelectedMac);localStorage.setItem('sensor_net_env_visible',JSON.stringify(envVisible));}catch(e){};envRender();});}var oldActivateTab=activateTab;activateTab=function(tid){oldActivateTab(tid);if('env'===tid)fetchEnvHistory();};if(envEntries.length)envRender();setInterval(fetchEnvHistory,60000);fetchEnvHistory();})();(function(){var plantMoistureHistory=[];var plantGraphVisible={};try{var _s=localStorage.getItem('sensor_net_plant_history');if(_s){var _j=JSON.parse(_s);if(Array.isArray(_j)){var _cut=Date.now()-21600000;_j=_j.filter(function(p){return (p&&p.ts_ms)>=_cut;});plantMoistureHistory=_j.slice(-600);}}var _v=localStorage.getItem('sensor_net_plant_visible');if(_v){var _o=JSON.parse(_v);if(_o&&typeof _o==='object')plantGraphVisible=_o;} }catch(e){};var PLANT_COLORS=['#00fff9','#ff00aa','#ffd166','#4dabff','#44bb44'];var sixH=21600000;var maxPts=600;window.pushPlantMoisture=function(nodes){if(!nodes||!nodes.length)return;var now=Date.now(),cut=now-sixH,i,n,chs,ci,key,lbl,hasValid;for(i=0;i<nodes.length;i++){n=nodes[i];if(!n||!n.mac)continue;chs=moistureChannels(n.moisture);hasValid=false;for(ci=0;ci<chs.length;ci++){if(chs[ci]!=null&&chs[ci]>=0)hasValid=true;}if(!hasValid){var j=0;while(j<plantMoistureHistory.length){if(plantMoistureHistory[j].mac===n.mac){plantMoistureHistory.splice(j,1);}else j++;}continue;}for(ci=0;ci<chs.length;ci++){if(chs[ci]==null||chs[ci]<0)continue;key=n.mac+':'+ci;lbl=(plantLabelForChannel(n,ci)||'').trim()||(n.label||n.mac)+' Ch'+(ci+1);plantMoistureHistory.push({ts_ms:now,mac:n.mac,ch:ci,value:Number(chs[ci]),label:lbl,key:key});}}while(plantMoistureHistory.length>maxPts)plantMoistureHistory.shift();var j=0;while(j<plantMoistureHistory.length&&plantMoistureHistory[j].ts_ms<cut)j++;if(j>0)plantMoistureHistory.splice(0,j);try{localStorage.setItem('sensor_net_plant_history',JSON.stringify(plantMoistureHistory));localStorage.setItem('sensor_net_plant_visible',JSON.stringify(plantGraphVisible));}catch(e){};};function getPlantList(){var seen={},list=[],i,e,cut=Date.now()-sixH;for(i=plantMoistureHistory.length-1;i>=0;i--){e=plantMoistureHistory[i];if(!e||e.ts_ms<cut)continue;if(e.value==null||e.value<0)continue;if(!seen[e.key]){seen[e.key]=true;list.unshift({key:e.key,mac:e.mac,ch:e.ch,label:e.label});}}return list;}function drawPlantGraph(){var cv=el('plantGraph'),timeEl=el('plantGraphTime');if(!cv)return;var ctx=cv.getContext('2d');if(!ctx)return;var wrap=cv.parentElement;if(wrap&&wrap.clientWidth>0&&wrap.clientHeight>0){var dw=wrap.clientWidth,dh=wrap.clientHeight;if(cv.width!==dw||cv.height!==dh){cv.width=dw;cv.height=dh;}}var w=cv.width,h=cv.height,x0=50,y0=20,x1=w-50,y1=h-20,axisColor=document.body.getAttribute('data-skin')==='rwb'?'#0f172a':'rgba(154,255,197,0.9)';ctx.clearRect(0,0,w,h);if(timeEl)timeEl.textContent='';var list=getPlantList(),visible=list.filter(function(p){return plantGraphVisible[p.key]!==false;});if(visible.length===0){visible=list;list.forEach(function(p){plantGraphVisible[p.key]=true;});}var cut=Date.now()-sixH,byKey={},i,e,k;for(i=0;i<plantMoistureHistory.length;i++){e=plantMoistureHistory[i];if(e.ts_ms<cut)continue;k=e.key;if(plantGraphVisible[k]===false)continue;if(!byKey[k])byKey[k]=[];byKey[k].push({ts:e.ts_ms,val:e.value});}var keys=visible.map(function(p){return p.key;});var minTs=1/0,maxTs=-1/0;keys.forEach(function(k){var pts=byKey[k];if(pts&&pts.length){pts.forEach(function(p){if(p.ts<minTs)minTs=p.ts;if(p.ts>maxTs)maxTs=p.ts;});}});if(minTs>maxTs){ctx.fillStyle=axisColor;ctx.font='12px Consolas, monospace';ctx.fillText('Select plants below. Data builds over time.',24,Math.round(h/2));return;}var idx=0;ctx.strokeStyle='rgba(54,255,122,0.2)';ctx.lineWidth=1;for(i=0;i<=4;i++){var gy=y0+(y1-y0)*i/4;ctx.beginPath();ctx.moveTo(x0,gy);ctx.lineTo(x1,gy);ctx.stroke();}ctx.fillStyle=axisColor;ctx.font='10px Consolas, monospace';ctx.textAlign='right';for(i=0;i<=4;i++)ctx.fillText((100-i*25)+'%',x0-4,y0+(y1-y0)*i/4);keys.forEach(function(k){var pts=byKey[k];if(!pts||!pts.length)return;pts.sort(function(a,b){return a.ts-b.ts;});var col=PLANT_COLORS[idx%PLANT_COLORS.length];idx++;ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();var first=true;pts.forEach(function(p){var xv=x0+(x1-x0)*(p.ts-minTs)/(maxTs-minTs),yv=y1-(p.val/100)*(y1-y0);if(first){ctx.moveTo(xv,yv);first=false;}else ctx.lineTo(xv,yv);});ctx.stroke();});ctx.fillStyle=axisColor;ctx.textBaseline='top';for(var xi=0;xi<=4;xi++){var xPos=x0+(x1-x0)*xi/4,t=new Date(minTs+(maxTs-minTs)*xi/4);ctx.textAlign=xi===0?'left':(xi===4?'right':'center');ctx.fillText(t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),xPos,y1+4);}if(timeEl)timeEl.textContent='Last 6h - '+new Date(minTs).toLocaleTimeString()+' - '+new Date(maxTs).toLocaleTimeString();}window.renderPlantGraph=function(){var wrap=el('plantGraphSelect');if(!wrap)return;var list=getPlantList();if(!list.length){wrap.innerHTML='';drawPlantGraph();return;}list.forEach(function(p){if(plantGraphVisible[p.key]===undefined)plantGraphVisible[p.key]=true;});var html=[];list.forEach(function(p){var on=plantGraphVisible[p.key]!==false;html.push(LT+'button type="button" class="env-sensor-btn'+(on?' active':'')+'" data-plant-key="'+esc(p.key)+'"'+'>'+esc(p.label)+LTS+'button>');});wrap.innerHTML=html.join('');wrap.querySelectorAll('.env-sensor-btn').forEach(function(btn){var k=btn.getAttribute('data-plant-key');btn.onclick=function(){plantGraphVisible[k]=!plantGraphVisible[k];btn.classList.toggle('active',plantGraphVisible[k]);try{localStorage.setItem('sensor_net_plant_visible',JSON.stringify(plantGraphVisible));}catch(e){};drawPlantGraph();};});drawPlantGraph();};})();(function(){var ftSelected='all';var ftNodes=[];var ftEntries=[];var ftVisible={temp:true,tds:true};try{var _ft=localStorage.getItem('sensor_net_fishtank_visible');if(_ft){var _ftj=JSON.parse(_ft);if(_ftj&&typeof _ftj==='object')ftVisible=_ftj;} }catch(e){}function isTankNode(n){if(!n||!n.mac)return false;var l=(n.label||'').toLowerCase();var isL=l.indexOf('tank')>=0||l.indexOf('aquarium')>=0||l.indexOf('fish')>=0;var hasTankData=(n.temperature_water!=null&&isFinite(n.temperature_water)&&n.temperature_water>-500)||(n.tds_ppm!=null&&isFinite(n.tds_ppm)&&n.tds_ppm>=0);return isL||hasTankData;}function ftWaterF(e){var w=e.temperature_water;if(w!=null&&isFinite(w)&&w>-500)return c2f(w);if(e.temperature!=null&&isFinite(e.temperature))return c2f(e.temperature);return null;}function drawFishtankGraph(entries){var cv=el('fishtankGraph'),timeEl=el('fishtankGraphTime');if(!cv)return;var ctx=cv.getContext('2d');if(!ctx)return;var wrap=cv.parentElement;if(wrap&&wrap.clientWidth>0&&wrap.clientHeight>0){var dw=wrap.clientWidth,dh=wrap.clientHeight;if(cv.width!==dw||cv.height!==dh){cv.width=dw;cv.height=dh;}}var w=cv.width,h=cv.height,leftPad=50,rightPad=50,y0=20,x0=leftPad,x1=w-rightPad,y1=h-20,axisColor=document.body.getAttribute('data-skin')==='rwb'?'#0f172a':'rgba(154,255,197,0.9)';ctx.clearRect(0,0,w,h);if(timeEl)timeEl.textContent='';if(!entries||!entries.length){ctx.fillStyle=axisColor;ctx.font='12px Consolas, monospace';ctx.fillText('No tank data in log yet',24,Math.round(h/2));return;}var s=entries.slice().sort(function(a,b){return Number(a.ts_ms||0)-Number(b.ts_ms||0);});var maxTs=s.length?Math.max.apply(null,s.map(function(e){return Number(e.ts_ms||0);})):0;var sixH=21600000,cutoff=(maxTs>1e12)?(Date.now()-sixH):(maxTs-sixH);s=s.filter(function(e){return Number(e.ts_ms||0)>=cutoff;});if(!s.length){s=entries.slice().sort(function(a,b){return Number(a.ts_ms||0)-Number(b.ts_ms||0);});s=s.filter(function(e){return Number(e.ts_ms||0)>=(maxTs-sixH);});}if(!s.length){ctx.fillStyle=axisColor;ctx.fillText('No data in last 6h',24,Math.round(h/2));return;}var tv=[],tdsv=[],i,v;for(i=0;i<s.length;i++){v=ftWaterF(s[i]);if(v!=null)tv.push(v);v=s[i].tds_ppm;if(v!=null&&isFinite(v)&&v>=0)tdsv.push(Number(v));}function rr(vals,lo,hi){if(!vals.length)return {min:lo,max:hi};var mn=Math.min.apply(null,vals),mx=Math.max.apply(null,vals);if(mn===mx){mn-=1;mx+=1;}return {min:mn,max:mx};}var tr=rr(tv,68,86),tdsR=rr(tdsv,0,500);ctx.strokeStyle='rgba(54,255,122,0.2)';ctx.lineWidth=1;for(i=0;i<=4;i++){var gy=y0+(y1-y0)*i/4;ctx.beginPath();ctx.moveTo(x0,gy);ctx.lineTo(x1,gy);ctx.stroke();}ctx.fillStyle=axisColor;ctx.font='10px Consolas, monospace';ctx.textAlign='right';ctx.textBaseline='middle';for(i=0;i<=4;i++){var gy=y0+(y1-y0)*i/4;ctx.fillText(tr.max-(tr.max-tr.min)*i/4+'F',x0-4,gy);}ctx.textAlign='left';for(i=0;i<=4;i++){var gy=y0+(y1-y0)*i/4;ctx.fillText(Math.round(tdsR.max-(tdsR.max-tdsR.min)*i/4)+'',x1+4,gy);}if(ftVisible.temp){ctx.strokeStyle='#00fff9';ctx.lineWidth=2;ctx.beginPath();var st=false;for(i=0;i<s.length;i++){var xv=x0+(x1-x0)*i/Math.max(1,s.length-1);var v=ftWaterF(s[i]);if(v==null){st=false;continue;}var y=y1-((v-tr.min)/(tr.max-tr.min))*(y1-y0);if(!st){ctx.moveTo(xv,y);st=true;}else ctx.lineTo(xv,y);}ctx.stroke();}if(ftVisible.tds){ctx.strokeStyle='#4dabff';ctx.lineWidth=2;ctx.beginPath();st=false;for(i=0;i<s.length;i++){var xv=x0+(x1-x0)*i/Math.max(1,s.length-1);var v=s[i].tds_ppm;if(v==null||!isFinite(v)||v<0){st=false;continue;}var y=y1-((v-tdsR.min)/(tdsR.max-tdsR.min))*(y1-y0);if(!st){ctx.moveTo(xv,y);st=true;}else ctx.lineTo(xv,y);}ctx.stroke();}ctx.fillStyle=axisColor;ctx.textBaseline='top';for(var xi=0;xi<=4;xi++){var xPos=x0+(x1-x0)*xi/4,minTs=s[0].ts_ms,maxTsS=s[s.length-1].ts_ms,t=new Date(Number(minTs)+(Number(maxTsS)-Number(minTs))*xi/4);ctx.textAlign=xi===0?'left':(xi===4?'right':'center');ctx.fillText(t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),xPos,y1+4);}if(timeEl)timeEl.textContent='Last 6h - '+new Date(s[0].ts_ms).toLocaleTimeString()+' - '+new Date(s[s.length-1].ts_ms).toLocaleTimeString();}function ftRender(){var selWrap=el('fishtankGraphSelect'),labelEl=el('fishtankGraphLabel');if(!selWrap)return;var tankNodes=ftNodes.filter(isTankNode);var byName={};for(var i=0;i<tankNodes.length;i++){var n=tankNodes[i],tname=(n.label||n.mac||'').trim();if(!byName[tname])byName[tname]=[];byName[tname].push(n.mac);}var names=Object.keys(byName).sort();var tankMacs={};tankNodes.forEach(function(n){tankMacs[n.mac]=true;});var filtered=ftEntries.filter(function(e){if(!e||!tankMacs[e.mac])return false;var hasTemp=ftWaterF(e)!=null;var hasTds=e.tds_ppm!=null&&isFinite(e.tds_ppm)&&e.tds_ppm>=0;return hasTemp||hasTds;});if(ftSelected!=='all'&&!byName[ftSelected])ftSelected='all';var filtered2=ftSelected==='all'?filtered:filtered.filter(function(e){var macs=byName[ftSelected];return macs&&macs.indexOf(e.mac)>=0;});if(labelEl)labelEl.textContent=ftSelected==='all'?'All tanks':ftSelected;var btns=[LT+'button type="button" class="env-sensor-btn'+(ftSelected==='all'?' active':'')+'" data-ft="all"'+'>All tanks'+LTS+'button>'];names.forEach(function(tname){btns.push(LT+'button type="button" class="env-sensor-btn'+(ftSelected===tname?' active':'')+'" data-ft="'+esc(tname)+'"'+'>'+esc(tname)+LTS+'button>');});selWrap.innerHTML=btns.join('');selWrap.querySelectorAll('.env-sensor-btn').forEach(function(btn){btn.onclick=function(){ftSelected=btn.getAttribute('data-ft')||'all';ftRender();};});document.querySelectorAll('#fishtank .graph-legend-btn').forEach(function(btn){var series=btn.getAttribute('data-series');if(!series)return;btn.classList.toggle('off',!ftVisible[series]);btn.onclick=function(){ftVisible[series]=!ftVisible[series];btn.classList.toggle('off',!ftVisible[series]);try{localStorage.setItem('sensor_net_fishtank_visible',JSON.stringify(ftVisible));}catch(e){};drawFishtankGraph(ftSelected==='all'?filtered:filtered2);};});drawFishtankGraph(filtered2);}function fetchFishtankHistory(){Promise.all([fetch('/api/sensors').then(function(r){return r.json();}).catch(function(){return {nodes:[]};}),fetch('/api/log').then(function(r){return r.json();}).catch(function(){return {entries:[]};})]).then(function(rs){ftNodes=rs[0]&&rs[0].nodes?rs[0].nodes:[];ftEntries=rs[1]&&rs[1].entries?rs[1].entries:[];ftRender();});}var oldFtTab=activateTab;activateTab=function(tid){oldFtTab(tid);if(tid==='fishtank')fetchFishtankHistory();};})();(function(){var LAYOUT_KEY='dashboardLayout';var CARD_LABELS={system:'System',motion:'Motion (Security)',sensors:'Sensors',env:'Environment',plant:'Plant',fishtank:'Fish tank',log:'Data log',ble_log:'BLE Log',wifi_log:'WiFi Log'};function getLayout(){try{var s=localStorage.getItem(LAYOUT_KEY);if(s){var j=JSON.parse(s);if(j&&(j.order||j.removed||j.hidden))return j;} }catch(e){}return {order:[],removed:[],hidden:{}};}function saveLayout(layout){try{localStorage.setItem(LAYOUT_KEY,JSON.stringify(layout));}catch(e){}}function applyLayout(){var grid=document.querySelector('#overview .overview-grid');if(!grid)return;var cards=Array.from(grid.querySelectorAll('.overview-card'));if(!cards.length)return;cards.forEach(function(c){var id=c.getAttribute('data-goto-tab');if(id)c.setAttribute('data-card-id',id);});var layout=getLayout();var order=layout.order&&layout.order.length?layout.order:cards.map(function(c){return c.getAttribute('data-card-id');}).filter(Boolean);var removed=layout.removed||[];var hidden=layout.hidden||{};cards.forEach(function(c){var id=c.getAttribute('data-card-id');if(!id)return;c.classList.toggle('card-removed',removed.indexOf(id)>=0);c.classList.toggle('card-hidden',!!hidden[id]);});var byId={};cards.forEach(function(c){var id=c.getAttribute('data-card-id');if(id)byId[id]=c;});var visibleOrder=order.filter(function(id){return removed.indexOf(id)<0&&byId[id];});visibleOrder.forEach(function(id){var card=byId[id];if(card)grid.appendChild(card);});var removedOrder=order.filter(function(id){return removed.indexOf(id)>=0&&byId[id];});removedOrder.forEach(function(id){var card=byId[id];if(card)grid.appendChild(card);});cards.forEach(function(c){var id=c.getAttribute('data-card-id');if(id&&visibleOrder.indexOf(id)<0&&removedOrder.indexOf(id)<0&&byId[id])grid.appendChild(c);});}function buildLayoutBar(){var bar=el('overviewLayoutBar');if(!bar)return;bar.innerHTML='';var layout=getLayout();var removed=layout.removed||[];var wrap=document.createElement('div');wrap.className='layout-add-wrap';var sel=document.createElement('select');sel.className='layout-add-select';sel.innerHTML='<option value="">Add card...</option>';removed.forEach(function(id){var opt=document.createElement('option');opt.value=id;opt.textContent=CARD_LABELS[id]||id;sel.appendChild(opt);});sel.onchange=function(){var id=this.value;if(!id)return;var l=getLayout();l.removed=(l.removed||[]).filter(function(x){return x!==id;});saveLayout(l);applyLayout();injectCardToolbars();buildLayoutBar();this.value='';bindOverviewGoto();};wrap.appendChild(sel);bar.appendChild(wrap);var resetBtn=document.createElement('button');resetBtn.type='button';resetBtn.className='btn-reset-layout';resetBtn.textContent='Reset layout';resetBtn.onclick=function(){saveLayout({order:[],removed:[],hidden:{}});applyLayout();injectCardToolbars();buildLayoutBar();bindOverviewGoto();};bar.appendChild(resetBtn);}function bindOverviewGoto(){document.querySelectorAll('#overview .overview-goto').forEach(function(btn){btn.onclick=function(){var t=this.getAttribute('data-goto-tab');if(t)activateTab(t);};});}function injectCardToolbars(){var grid=document.querySelector('#overview .overview-grid');if(!grid)return;var cards=grid.querySelectorAll('.overview-card');cards.forEach(function(card){if(card.querySelector('.card-toolbar'))return;var id=card.getAttribute('data-card-id');if(!id)return;var toolbar=document.createElement('div');toolbar.className='card-toolbar';var handle=document.createElement('button');handle.type='button';handle.className='card-drag-handle';handle.setAttribute('aria-label','Drag to reorder');handle.textContent='\u2630';var menuBtn=document.createElement('button');menuBtn.type='button';menuBtn.className='card-menu-btn';menuBtn.setAttribute('aria-label','Card menu');menuBtn.textContent='\u22EE';var dropdown=document.createElement('div');dropdown.className='card-menu-dropdown';var hideBtn=document.createElement('button');hideBtn.type='button';hideBtn.textContent='';hideBtn.onclick=function(){var l=getLayout();l.hidden=l.hidden||{};l.hidden[id]=!l.hidden[id];saveLayout(l);applyLayout();injectCardToolbars();buildLayoutBar();dropdown.classList.remove('show');};var removeBtn=document.createElement('button');removeBtn.type='button';removeBtn.textContent='Remove from dashboard';removeBtn.onclick=function(){var l=getLayout();l.removed=l.removed||[];if(l.removed.indexOf(id)<0)l.removed.push(id);saveLayout(l);applyLayout();injectCardToolbars();buildLayoutBar();bindOverviewGoto();dropdown.classList.remove('show');};dropdown.appendChild(hideBtn);dropdown.appendChild(removeBtn);menuBtn.onclick=function(e){e.stopPropagation();var open=dropdown.classList.toggle('show');if(open){hideBtn.textContent=((getLayout().hidden||{})[id])?'Show card':'Hide card';document.addEventListener('click',function close(){document.removeEventListener('click',close);dropdown.classList.remove('show');});setTimeout(function(){document.addEventListener('click',close);},0);}};toolbar.appendChild(handle);toolbar.appendChild(menuBtn);toolbar.appendChild(dropdown);card.insertBefore(toolbar,card.firstChild);handle.onmousedown=function(e){if(e.button!==0)return;var startX=e.clientX,startY=e.clientY;var cardEl=card;cardEl.classList.add('dragging');var overEl=null;function move(ev){var dx=ev.clientX-startX,dy=ev.clientY-startY;if(Math.abs(dx)>4||Math.abs(dy)>4){var elUnder=document.elementFromPoint(ev.clientX,ev.clientY);var other=elUnder&&elUnder.closest('.overview-card');if(other&&other!==cardEl&&!other.classList.contains('card-removed')){if(overEl)overEl.classList.remove('drag-over');overEl=other;overEl.classList.add('drag-over');}}}function up(ev){document.removeEventListener('mousemove',move);document.removeEventListener('mouseup',up);cardEl.classList.remove('dragging');if(overEl){overEl.classList.remove('drag-over');var layout=getLayout();var order=layout.order&&layout.order.length?layout.order:Array.from(grid.querySelectorAll('.overview-card')).map(function(c){return c.getAttribute('data-card-id');}).filter(Boolean);var removed=layout.removed||[];var visibleOrder=order.filter(function(i){return removed.indexOf(i)<0;});var fromId=cardEl.getAttribute('data-card-id');var toId=overEl.getAttribute('data-card-id');if(fromId&&toId&&fromId!==toId){var fromIdx=visibleOrder.indexOf(fromId),toIdx=visibleOrder.indexOf(toId);if(fromIdx>=0&&toIdx>=0){visibleOrder.splice(fromIdx,1);visibleOrder.splice(toIdx,0,fromId);layout.order=visibleOrder.slice();var allIds=Array.from(grid.querySelectorAll('.overview-card')).map(function(c){return c.getAttribute('data-card-id');}).filter(Boolean);allIds.forEach(function(i){if(visibleOrder.indexOf(i)<0)visibleOrder.push(i);});layout.order=visibleOrder;saveLayout(layout);applyLayout();injectCardToolbars();buildLayoutBar();bindOverviewGoto();}}}overEl=null;}document.addEventListener('mousemove',move);document.addEventListener('mouseup',up);};});}function initDashboardLayout(){applyLayout();injectCardToolbars();buildLayoutBar();bindOverviewGoto();}if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',initDashboardLayout);else initDashboardLayout();var oldActivateTabOverview=activateTab;activateTab=function(tid){oldActivateTabOverview(tid);if(tid==='overview')setTimeout(initDashboardLayout,60);};})();