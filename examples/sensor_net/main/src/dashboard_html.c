/* Embedded dashboard HTML for Sensor Gateway (ESP-NOW + HaLow). */
#include "sensor_gateway_http.h"

static const char s_html[] =
"<!DOCTYPE html><html><head><meta charset=\"UTF-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">"
"<title>Sensor Gateway (HaLow)</title>"
"<style>"
"*{box-sizing:border-box}"
"body{font-family:'Consolas','Monaco','Courier New',monospace;margin:0;padding:16px;background:#050b08;color:#d6ffe8;min-height:100vh}"
"body::before{content:'';position:fixed;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#00ff9a,#36ff7a,#00ff9a);background-size:200% 100%;opacity:0.85;z-index:1;animation:scanline 6s linear infinite}"
"@keyframes scanline{0%{background-position:0% 50%}100%{background-position:200% 50%}}"
"@keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.6);opacity:0.4}100%{transform:scale(1);opacity:1}}"
".topbar{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:16px}"
"h1{font-size:1.4rem;margin:0;color:#36ff7a;text-shadow:0 0 12px rgba(54,255,122,0.5);letter-spacing:0.08em;text-transform:uppercase}"
".subtitle{margin:6px 0 0;color:#9affc5;font-size:0.85rem;letter-spacing:0.04em}"
".nav a{display:inline-block;margin-left:10px;padding:6px 10px;border:1px solid #1e293b;border-radius:4px;color:#00ff9a;text-decoration:none;letter-spacing:0.05em}"
".nav a.active{border-color:#36ff7a;color:#36ff7a;box-shadow:0 0 12px rgba(54,255,122,0.25)}"
".tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}"
".tabs button{padding:8px 14px;border:1px solid #1e293b;background:#0d1411;color:#36ff7a;border-radius:4px;cursor:pointer;letter-spacing:0.04em}"
".tabs button.active{background:rgba(54,255,122,0.12);box-shadow:0 0 12px rgba(54,255,122,0.25)}"
".panel{display:none}.panel.active{display:block}"
"table{width:100%;border-collapse:collapse;font-size:0.9rem}"
"th,td{padding:8px;text-align:left;border-bottom:1px solid #1e293b}"
"th{color:#9affc5;font-weight:500}"
"tr.motion{background:rgba(54,255,122,0.12);color:#d6ffe8;box-shadow:inset 0 0 18px rgba(54,255,122,0.15)}"
"tr:hover{background:rgba(54,255,122,0.08);box-shadow:inset 0 0 14px rgba(54,255,122,0.12)}"
".sensor-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}"
".sensor-card{border:1px solid #1e293b;border-radius:6px;padding:10px;background:#0d1411;box-shadow:0 0 12px rgba(54,255,122,0.12);display:flex;flex-direction:column;gap:8px}"
".sensor-card.motion{border-color:#ff2f2f;background:rgba(255,47,47,0.25);box-shadow:0 0 20px rgba(255,47,47,0.45);cursor:pointer}"
".sensor-head{display:flex;justify-content:space-between;align-items:center;gap:8px}"
".sensor-ident{display:flex;align-items:center;gap:8px}"
".sensor-actions{display:flex;align-items:center;gap:6px;flex-wrap:wrap;justify-content:flex-end}"
".status-dot{width:8px;height:8px;border-radius:50%;background:#1e293b;flex:0 0 auto}"
".status-dot.pulse{background:#36ff7a;box-shadow:0 0 10px rgba(54,255,122,0.8);animation:pulse 0.8s ease}"
".sensor-title{font-weight:600;color:#d6ffe8}"
".sensor-mac{font-size:0.75rem;color:#9affc5}"
".sensor-data{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px;font-size:0.85rem}"
".sensor-data div{display:flex;justify-content:space-between;gap:8px;padding:4px 6px;background:#101620;border:1px solid #1e293b;border-radius:4px}"
".sensor-data span{color:#9affc5}"
".sensor-motion{font-weight:600;color:#ff5c5c}"
".sensor-card.motion .sensor-motion{color:#ffd1d1}"
".sensor-card.stale{border-color:#3a3f46;background:#0b1010;color:#9aa3ad;box-shadow:none;filter:grayscale(0.7)}"
".sensor-card.stale .sensor-title,.sensor-card.stale .sensor-mac,.sensor-card.stale .sensor-data span{color:#8d98a3}"
".sensor-card.stale .status-dot{background:#6b7280;box-shadow:none;animation:none}"
".sensor-card.selected{border-color:#36ff7a;box-shadow:0 0 16px rgba(54,255,122,0.4)}"
".btnRemove{border-color:#3b1d1d;color:#ffb3b3;background:#140a0a}"
".btnRemove:hover{box-shadow:0 0 10px rgba(255,92,92,0.35)}"
".halow-card{border:1px solid #1e293b;border-radius:6px;padding:12px;background:#0d1411;box-shadow:0 0 12px rgba(54,255,122,0.18);margin-bottom:12px}"
".halow-card h3{margin:0 0 8px;font-size:0.95rem;letter-spacing:0.06em;color:#9affc5;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between;gap:10px}"
".rssi-bar{height:6px;border-radius:999px;background:#0b1010;border:1px solid #1e293b;overflow:hidden;box-shadow:inset 0 0 10px rgba(0,0,0,0.5);margin:4px 0 10px}"
".rssi-fill{height:100%;width:0%;background:linear-gradient(90deg,#ff5c5c 0%,#4dabff 55%,#36ff7a 100%);box-shadow:0 0 10px rgba(77,171,255,0.35);transition:width 0.3s ease}"
".halow-title{display:flex;align-items:center;gap:8px}"
".halow-indicator{width:8px;height:8px;border-radius:50%;background:#1e293b;box-shadow:none}"
".halow-indicator.up{background:#36ff7a;box-shadow:0 0 10px rgba(54,255,122,0.8);animation:pulse 0.9s ease-in-out infinite}"
".halow-indicator.down{background:#ff5c5c;box-shadow:0 0 10px rgba(255,92,92,0.6);animation:pulse 1.1s ease-in-out infinite}"
".halow-actions{display:flex;align-items:center;gap:8px}"
".card-toggle{border:1px solid #1e293b;color:#9affc5;background:#0d1411;font-size:0.75rem;padding:4px 8px;letter-spacing:0.05em}"
".card-toggle:hover{box-shadow:0 0 10px rgba(54,255,122,0.25)}"
".collapsible-body{display:none}"
".collapsible.open .collapsible-body{display:block}"
".sys-indicator{width:8px;height:8px;border-radius:50%;background:#1e293b;box-shadow:none;flex:0 0 auto}"
".sys-indicator.ok{background:#36ff7a;box-shadow:0 0 10px rgba(54,255,122,0.8);animation:pulse 0.9s ease-in-out infinite}"
".sys-indicator.warn{background:#f5c542;box-shadow:0 0 10px rgba(245,197,66,0.7);animation:pulse 0.9s ease-in-out infinite}"
".sys-indicator.crit{background:#ff5c5c;box-shadow:0 0 12px rgba(255,92,92,0.8);animation:pulse 0.9s ease-in-out infinite}"
".halow-status{font-size:0.85rem;color:#9affc5;margin-bottom:6px}"
".halow-card.disconnected{border-color:#ff5c5c;background:rgba(80,12,12,0.55);box-shadow:0 0 16px rgba(255,92,92,0.35)}"
".halow-card.disconnected h3{color:#ff5c5c}"
".halow-card.disconnected .halow-status{color:#ffb3b3}"
".halow-mac{font-size:0.8rem;color:#9affc5;margin-bottom:8px}"
".halow-card .sensor-data{grid-template-columns:repeat(3,minmax(0,1fr))}"
".gateway-card{border:1px solid #1e293b;border-radius:6px;padding:12px;background:#0d1411;box-shadow:0 0 12px rgba(54,255,122,0.18);margin-bottom:12px}"
".gateway-card h3{margin:0 0 8px;font-size:0.95rem;letter-spacing:0.06em;color:#9affc5;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between;gap:10px}"
".gateway-card .sensor-data{grid-template-columns:repeat(2,minmax(0,1fr))}"
".system-card .sensor-data{grid-template-columns:repeat(1,minmax(0,1fr))}"
"@media (max-width:640px){.halow-card .sensor-data{grid-template-columns:repeat(2,minmax(0,1fr))}}"
"input,button{padding:8px;border-radius:4px;border:1px solid #1e293b;background:#0d1411;color:#d6ffe8;font-family:inherit}"
"button{cursor:pointer;letter-spacing:0.04em}"
".primary{border-color:#36ff7a;color:#36ff7a;background:rgba(54,255,122,0.08);box-shadow:0 0 10px rgba(54,255,122,0.15)}"
".primary:hover{box-shadow:0 0 16px rgba(54,255,122,0.45)}"
"#labelEditForm{margin-bottom:12px;padding:10px;background:#101620;border:1px solid #1e293b;border-radius:6px;display:none}"
"#labelEditForm.show{display:block}"
".cam-controls{display:flex;align-items:center;gap:12px;margin-bottom:10px}"
".toggle{display:flex;align-items:center;gap:8px;color:#9affc5}"
".toggle input{accent-color:#36ff7a}"
".muted{color:#9affc5;font-size:0.85rem}"
".cam-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}"
".cam-box{border:1px solid #ff5c5c;border-radius:6px;overflow:hidden;background:rgba(60,12,12,0.6);box-shadow:0 0 14px rgba(255,92,92,0.28)}"
".cam-box img{width:100%;height:200px;object-fit:cover;display:block}"
".cam-empty{padding:16px;border:1px dashed #1e293b;border-radius:6px;color:#9affc5;text-align:center}"
".cyberpunk-art{position:relative;margin:0 0 16px;padding:12px;border:1px solid #1e293b;border-radius:6px;"
"background:linear-gradient(135deg,rgba(54,255,122,0.12),rgba(0,0,0,0));overflow:hidden}"
".cyberpunk-art::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(135deg,transparent 0,transparent 10px,rgba(54,255,122,0.08) 10px,rgba(54,255,122,0.08) 12px)}"
".cyberpunk-art::after{content:'';position:absolute;right:-20px;top:-20px;width:96px;height:96px;border:2px solid rgba(54,255,122,0.55);border-radius:50%;box-shadow:0 0 18px rgba(54,255,122,0.35)}"
".cyberpunk-art .art-grid{position:absolute;inset:0;background:linear-gradient(transparent 75%,rgba(54,255,122,0.08) 75%),"
"linear-gradient(90deg,transparent 75%,rgba(54,255,122,0.08) 75%);background-size:22px 22px;mix-blend-mode:screen;opacity:0.6}"
".cyberpunk-art .art-title{position:relative;font-size:0.8rem;letter-spacing:0.3em;text-transform:uppercase;color:#9affc5;text-shadow:0 0 10px rgba(54,255,122,0.35)}"
".graph-card{border:1px solid #1e293b;border-radius:6px;padding:12px;background:#0d1411;box-shadow:0 0 14px rgba(54,255,122,0.2);margin-bottom:12px}"
".graph-title{display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:0.85rem;letter-spacing:0.2em;text-transform:uppercase;color:#9affc5;margin:0 0 8px}"
".graph-subtitle{font-size:0.7rem;letter-spacing:0.08em;text-transform:none;color:#9affc5;opacity:0.85}"
".graph-time{font-size:0.7rem;letter-spacing:0.08em;color:#9affc5;opacity:0.75;margin-top:6px}"
".graph-wrap{position:relative;border:1px solid #1e293b;border-radius:6px;background:#07110b;overflow:hidden}"
".graph-wrap::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(90deg,rgba(54,255,122,0.06) 0,rgba(54,255,122,0.06) 1px,transparent 1px,transparent 24px),"
"repeating-linear-gradient(0deg,rgba(54,255,122,0.06) 0,rgba(54,255,122,0.06) 1px,transparent 1px,transparent 24px);opacity:0.45;pointer-events:none}"
".graph-legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;font-size:0.8rem;color:#9affc5}"
".graph-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;box-shadow:0 0 10px currentColor}"
".dot-temp{color:#00fff9}"
".dot-hum{color:#ff00aa}"
".dot-aqi{color:#ffd166}"
"</style></head><body>"
"<div class=\"topbar\"><div><h1>Sensor Gateway</h1><p class=\"subtitle\">HaLow uplink + ESP-NOW sensors on 2.4 GHz ch6. v1.0.1</p></div>"
"<div class=\"nav\"><a href=\"/\" class=\"active\">Dashboard</a><a href=\"/settings\">Settings</a></div></div>"
"<div class=\"cyberpunk-art\" aria-hidden=\"true\"><div class=\"art-grid\"></div><div class=\"art-title\">SYSTEM CORE</div></div>"
"<div class=\"tabs\"><button data-tab=\"system\">System</button><button data-tab=\"motion\" class=\"active\">Motion</button><button data-tab=\"log\">Data log</button><button data-tab=\"cameras\">Cameras</button></div>"
"<div id=\"system\" class=\"panel\"><h2>System</h2>"
"<div id=\"systemCard\" class=\"gateway-card system-card collapsible\"><h3><span class=\"halow-title\"><span id=\"systemIndicator\" class=\"sys-indicator\"></span><span>System status</span></span><button type=\"button\" id=\"btnSystemToggle\" class=\"card-toggle\">Details</button></h3><div class=\"sensor-data\" id=\"systemSummary\">"
"<div><span>Heap used</span><strong id=\"statHeapPct\">-</strong></div>"
"</div><div id=\"systemDetails\" class=\"collapsible-body\"><div class=\"sensor-data\" id=\"systemStats\">"
"<div><span>Free heap</span><strong id=\"statHeapFree\">-</strong></div>"
"<div><span>Used heap</span><strong id=\"statHeapUsed\">-</strong></div>"
"<div><span>Min free heap</span><strong id=\"statHeapMinFree\">-</strong></div>"
"</div></div></div>"
"<div id=\"wifi2gCard\" class=\"gateway-card collapsible\"><h3><span class=\"halow-title\"><span id=\"wifi2gIndicator\" class=\"sys-indicator\"></span><span>2.4 GHz Status</span></span><button type=\"button\" id=\"btnWifi2gToggle\" class=\"card-toggle\">Details</button></h3><div class=\"sensor-data\" id=\"wifi2gSummary\">"
"<div><span>AP SSID</span><strong id=\"wifi2gApSsid\">-</strong></div>"
"<div><span>AP clients</span><strong id=\"wifi2gApClients\">-</strong></div>"
"</div><div id=\"wifi2gDetails\" class=\"collapsible-body\"><div class=\"sensor-data\">"
"<div><span>AP IP</span><strong id=\"wifi2gApIp\">-</strong></div>"
"<div><span>AP channel</span><strong id=\"wifi2gApChan\">-</strong></div>"
"<div><span>Backhaul</span><strong id=\"wifi2gBackhaul\">-</strong></div>"
"<div><span>STA SSID</span><strong id=\"wifi2gStaSsid\">-</strong></div>"
"<div><span>STA RSSI</span><strong id=\"wifi2gStaRssi\">-</strong></div>"
"<div><span>STA IP</span><strong id=\"wifi2gStaIp\">-</strong></div>"
"</div></div></div>"
"<div id=\"halowCard\" class=\"halow-card collapsible\"><h3><span class=\"halow-title\"><span id=\"halowIndicator\" class=\"halow-indicator\"></span><span>HaLow link</span></span><span class=\"halow-actions\"><button type=\"button\" id=\"btnHalowReconnect\" class=\"primary\">Reconnect</button><button type=\"button\" id=\"btnHalowToggle\" class=\"card-toggle\">Details</button><span id=\"halowReconnectStatus\" class=\"muted\"></span></span></h3><div class=\"rssi-bar\" aria-hidden=\"true\"><div id=\"halowRssiFill\" class=\"rssi-fill\"></div></div><div class=\"muted\" id=\"halowRssiText\">RSSI: -</div><div class=\"halow-status\" id=\"halowStatus\">Loading...</div><div class=\"halow-mac\" id=\"halowIpCollapsed\">IP: -</div><div id=\"halowDetails\" class=\"collapsible-body\"><div class=\"halow-mac\" id=\"halowMac\">MAC: -</div><div class=\"sensor-data\" id=\"halowData\"></div></div></div>"
"</div>"
"<div id=\"motion\" class=\"panel active\"><h2>Motion & sensors</h2>"
"<div id=\"gatewayCard\" class=\"gateway-card\"><h3>Sensor Mesh</h3><div class=\"sensor-data\" id=\"gatewayStats\">"
"<div><span>Gateways</span><strong id=\"statGateways\">1</strong></div>"
"<div><span>ESP-NOW nodes</span><strong id=\"statNodes\">-</strong></div>"
"</div></div>"
"<div class=\"graph-card\"><h3 class=\"graph-title\">Enviormental Telementry <span id=\"envGraphLabel\" class=\"graph-subtitle\">All sensors</span></h3>"
"<div class=\"graph-wrap\"><canvas id=\"envGraph\" width=\"360\" height=\"160\"></canvas></div>"
"<div class=\"graph-legend\">"
"<span><i class=\"graph-dot dot-temp\"></i>Temp (F)</span>"
"<span><i class=\"graph-dot dot-hum\"></i>Humidity (%)</span>"
"<span><i class=\"graph-dot dot-aqi\"></i>AQI</span>"
"</div></div>"
"<div id=\"labelEditForm\"><strong>Edit label</strong> <span id=\"labelEditMac\"></span>: <input id=\"labelEditInput\" placeholder=\"e.g. Living Room\"> <button type=\"button\" id=\"labelEditSave\" class=\"primary\">Save</button> <button type=\"button\" id=\"labelEditCancel\">Cancel</button></div>"
"<div id=\"sensorCards\" class=\"sensor-grid\"></div></div>"
"<div id=\"log\" class=\"panel\"><h2>Sensor data log</h2><p style=\"color:#9affc5;font-size:0.85rem\">Last 32 readings (persisted).</p><button type=\"button\" id=\"btnClearLog\" class=\"primary\" style=\"margin-bottom:10px\">Clear log</button><div style=\"overflow-x:auto\"><table><thead><tr><th>Time</th><th>MAC</th><th>Label</th><th>Motion</th><th>T (°F)</th><th>H (%)</th><th>P (hPa)</th><th>AQI</th><th>Uptime</th></tr></thead><tbody id=\"logRows\"></tbody></table></div></div>"
"<div id=\"cameras\" class=\"panel\"><h2>Camera streams</h2>"
"<div class=\"cam-controls\"><label class=\"toggle\"><input type=\"checkbox\" id=\"camEnable\"> Enable cameras</label><span id=\"camStatus\" class=\"muted\"></span></div>"
"<div id=\"camInputs\"></div><button type=\"button\" id=\"btnSaveCam\" class=\"primary\">Save</button><div class=\"cam-grid\" id=\"camGrid\"></div></div>"
"<script>"
"var editingMac=null;function showLabelEdit(mac,l){editingMac=mac;document.getElementById('labelEditMac').textContent=mac;document.getElementById('labelEditInput').value=l||'';document.getElementById('labelEditForm').classList.add('show');}"
"function hideLabelEdit(){editingMac=null;document.getElementById('labelEditForm').classList.remove('show');}"
"function saveLabel(mac,label){fetch('/api/labels',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:mac,label:label})}).then(function(){hideLabelEdit();});}"
"function resetTrigger(mac){if(!mac)return;if(!confirm('Reset trigger counter for '+mac+'?'))return;fetch('/api/sensors/reset',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:mac})}).then(function(){delete motionDismissed[mac];saveMotionDismissed();fetchSensors();});}"
"document.getElementById('labelEditSave').onclick=function(){if(editingMac)saveLabel(editingMac,document.getElementById('labelEditInput').value.trim());};"
"document.getElementById('labelEditCancel').onclick=hideLabelEdit;"
"function c2f(c){return Number(c)*9/5+32;}function gasToAqi(g){if(g===null||g===undefined||g==='')return null;var x=Number(g);if(!isFinite(x))return null;if(x<=0)return 500;if(x>=300)return 0;return Math.round(Math.max(0,Math.min(500,(300-x)/300*500)));}"
"function fmtFixed(v,d){if(v===null||v===undefined||v==='')return '';var x=Number(v);if(!isFinite(x))return '';return x.toFixed(d);}function fmtNum(v){if(v===null||v===undefined||v==='')return '';var x=Number(v);if(!isFinite(x))return '';return String(x);}function fmtBytes(v){if(v===null||v===undefined||v==='')return '';var x=Number(v);if(!isFinite(x))return '';if(x>=1048576)return (x/1048576).toFixed(1)+' MB';return Math.round(x/1024)+' kB';}function row(label,value,cls){if(value===null||value===undefined||value==='')return '';var c=cls?(' class=\"'+cls+'\"'):'';return '<div><span>'+label+'</span><strong'+c+'>'+value+'</strong></div>';}"
"function formatUptime(ms){var t=Math.max(0,Math.floor(Number(ms)/1000));var d=Math.floor(t/86400);t%=86400;var h=Math.floor(t/3600);t%=3600;var m=Math.floor(t/60);var s=t%60;var parts=[];if(d>0)parts.push(d+'d');if(h>0||d>0)parts.push(h+'h');if(m>0||h>0||d>0)parts.push(m+'m');parts.push(s+'s');return parts.join(' ');}"
"var motionDismissed={};try{motionDismissed=JSON.parse(localStorage.getItem('motionDismissed')||'{}')||{};}catch(e){motionDismissed={};}"
"function saveMotionDismissed(){localStorage.setItem('motionDismissed',JSON.stringify(motionDismissed));}"
"function isDismissed(mac,triggerCount){var m=motionDismissed[mac];if(!m||m.trigger!==triggerCount)return false;return (Date.now()-Number(m.ts||0))<30000;}"
"var hiddenSensors={};try{hiddenSensors=JSON.parse(localStorage.getItem('hiddenSensors')||'{}')||{};}catch(e){hiddenSensors={};}"
"function saveHiddenSensors(){localStorage.setItem('hiddenSensors',JSON.stringify(hiddenSensors));}"
"var sensorMeta={};"
"function getSensorSig(n){return [n.uptime_ms,n.trigger_count,n.motion,n.temperature,n.humidity,n.pressure,n.gas,n.rssi_dbm].join('|');}"
"function touchSensorMeta(n){var mac=n.mac||'';var now=Date.now();var meta=sensorMeta[mac]||{lastSig:'',lastUpdate:0,pulseUntil:0};var sig=getSensorSig(n);if(sig!==meta.lastSig){meta.lastSig=sig;meta.lastUpdate=now;meta.pulseUntil=now+800;}if(!meta.lastUpdate)meta.lastUpdate=now;sensorMeta[mac]=meta;return meta;}"
"var envHistory={t:[],h:[],a:[],ts:[],max:60};"
"var timeSyncValid=false;var timeBaseMs=0;var timeBaseClientMs=0;"
"function updateTimeSync(j){if(j&&j.time_valid&&j.time_ms!=null&&Number(j.time_ms)>0){timeSyncValid=true;timeBaseMs=Number(j.time_ms);timeBaseClientMs=Date.now();}else{timeSyncValid=false;}}"
"function getGatewayNowMs(){if(!timeSyncValid)return Date.now();return timeBaseMs+(Date.now()-timeBaseClientMs);}"
"function fmtClock(ms){var d=new Date(ms);return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});}"
"var selectedSensorMac=null;"
"function resetHistory(){envHistory.t=[];envHistory.h=[];envHistory.a=[];envHistory.ts=[];}"
"function pushHistory(arr,val){arr.push(val);if(arr===envHistory.t){envHistory.ts.push(getGatewayNowMs());if(envHistory.t.length>envHistory.max){envHistory.t.shift();envHistory.ts.shift();if(envHistory.h.length>envHistory.t.length)envHistory.h.shift();if(envHistory.a.length>envHistory.t.length)envHistory.a.shift();}}else if(arr.length>envHistory.t.length){arr.shift();}}"
"function drawEnvGraph(){var c=document.getElementById('envGraph');if(!c)return;var ctx=c.getContext('2d');var w=c.width;var h=c.height;ctx.clearRect(0,0,w,h);ctx.fillStyle='#07110b';ctx.fillRect(0,0,w,h);var pad=12;var innerW=w-pad*2;var innerH=h-pad*2;var tArr=envHistory.t;var hArr=envHistory.h;var aArr=envHistory.a;var tsArr=envHistory.ts;var count=tsArr.length;if(count<2)return;var tMin=Math.min.apply(null,tArr);var tMax=Math.max.apply(null,tArr);var hMin=Math.min.apply(null,hArr);var hMax=Math.max.apply(null,hArr);var tRange=Math.max(1,tMax-tMin);var hRange=Math.max(1,hMax-hMin);var aMin=0;var aMax=500;var tsMin=Math.min.apply(null,tsArr);var tsMax=Math.max.apply(null,tsArr);var tsRange=Math.max(1,tsMax-tsMin);function scaleY(val,min,range){return pad+innerH-(val-min)/range*innerH;}function scaleX(ts){return pad+innerW*((ts-tsMin)/tsRange);}function drawLine(arr,color,min,range){ctx.beginPath();for(var i=0;i<arr.length;i++){var x=scaleX(tsArr[i]);var y=scaleY(arr[i],min,range);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}ctx.strokeStyle=color;ctx.lineWidth=2;ctx.shadowColor=color;ctx.shadowBlur=8;ctx.stroke();ctx.shadowBlur=0;}var labels=[];function addLabel(val,color,min,range,fmt){if(val===null||val===undefined||!isFinite(val))return;labels.push({val:val,color:color,min:min,range:range,fmt:fmt});}function layoutLabels(){if(!labels.length)return;var minY=pad+6;var maxY=pad+innerH-6;var gap=12;labels.forEach(function(l){l.y=scaleY(l.val,l.min,l.range);});labels.sort(function(a,b){return a.y-b.y;});for(var i=1;i<labels.length;i++){if(labels[i].y-labels[i-1].y<gap)labels[i].y=labels[i-1].y+gap;}var overflow=labels[labels.length-1].y-maxY;if(overflow>0){for(var i=labels.length-1;i>=0;i--)labels[i].y-=overflow;}var under=minY-labels[0].y;if(under>0){for(var i=0;i<labels.length;i++)labels[i].y+=under;}}function drawLabels(){if(!labels.length)return;layoutLabels();ctx.font='11px Consolas,Monaco,Courier New,monospace';var lastX=scaleX(tsArr[count-1]);var padX=4;var alignRight=(lastX+60)>w;var tx=alignRight?(lastX-6):(lastX+6);ctx.textAlign=alignRight?'right':'left';ctx.textBaseline='middle';labels.forEach(function(l){var text=l.fmt(l.val);var m=ctx.measureText(text);ctx.fillStyle='rgba(7,17,11,0.75)';ctx.fillRect(tx+(alignRight?-m.width-padX:-padX),l.y-6,m.width+padX*2,12);ctx.fillStyle=l.color;ctx.fillText(text,tx,l.y);});}drawLine(tArr,'#00fff9',tMin,tRange);drawLine(hArr,'#ff00aa',hMin,hRange);drawLine(aArr,'#ffd166',aMin,aMax);addLabel(tArr[count-1],'#00fff9',tMin,tRange,function(v){return v.toFixed(1)+'F';});addLabel(hArr[count-1],'#ff00aa',hMin,hRange,function(v){return v.toFixed(1)+'%';});addLabel(aArr[count-1],'#ffd166',aMin,aMax,function(v){return String(Math.round(v));});drawLabels();ctx.font='10px Consolas,Monaco,Courier New,monospace';ctx.fillStyle='#9affc5';ctx.textAlign='center';ctx.textBaseline='top';if(timeSyncValid){var left=fmtClock(tsMin);var mid=fmtClock(Math.round((tsMin+tsMax)/2));var right=fmtClock(tsMax);ctx.fillText(left,pad,innerH+pad+2);ctx.fillText(mid,pad+innerW/2,innerH+pad+2);ctx.fillText(right,pad+innerW,innerH+pad+2);}else{ctx.fillText('-10m',pad,innerH+pad+2);ctx.fillText('-5m',pad+innerW/2,innerH+pad+2);ctx.fillText('now',pad+innerW,innerH+pad+2);}}"
"function renderHalow(h){var card=document.getElementById('halowCard');var status=document.getElementById('halowStatus');var macEl=document.getElementById('halowMac');var ipEl=document.getElementById('halowIpCollapsed');var data=document.getElementById('halowData');var indicator=document.getElementById('halowIndicator');var rssiFill=document.getElementById('halowRssiFill');var rssiText=document.getElementById('halowRssiText');if(!h){status.textContent='Unavailable';macEl.textContent='MAC: -';if(ipEl)ipEl.textContent='IP: -';data.innerHTML='';if(card)card.classList.add('disconnected');if(indicator){indicator.classList.remove('up');indicator.classList.add('down');}if(rssiFill)rssiFill.style.width='0%';if(rssiText)rssiText.textContent='RSSI: -';return;}status.textContent=h.up?'Connected':'Disconnected';if(card)card.classList.toggle('disconnected',!h.up);if(indicator){indicator.classList.toggle('up',!!h.up);indicator.classList.toggle('down',!h.up);}var rssiVal=(h.rssi_dbm===null||h.rssi_dbm===undefined)?null:Number(h.rssi_dbm);var rssi=(rssiVal===null||!isFinite(rssiVal))?'-':(rssiVal+' dBm');if(rssiFill){var min=-100;var max=-30;var pct=0;if(rssiVal!==null&&isFinite(rssiVal)){pct=Math.round(Math.max(0,Math.min(100,(rssiVal-min)/(max-min)*100)));}rssiFill.style.width=pct+'%';}if(rssiText)rssiText.textContent='RSSI: '+rssi;var ip=h.ip||'-';var gw=h.gateway||'-';var ssid=h.ssid||'-';var mac=h.mac||'-';var up=(h.link_uptime_s===null||h.link_uptime_s===undefined)?'-':formatUptime(h.link_uptime_s*1000);var bw=(h.bw_mhz===null||h.bw_mhz===undefined)?'-':(h.bw_mhz+' MHz');macEl.textContent='MAC: '+mac;if(ipEl)ipEl.textContent='IP: '+ip;data.innerHTML='<div><span>SSID</span><strong>'+ssid+'</strong></div>'+'<div><span>IP</span><strong>'+ip+'</strong></div>'+'<div><span>Gateway</span><strong>'+gw+'</strong></div>'+'<div><span>Link uptime</span><strong>'+up+'</strong></div>'+'<div><span>RSSI</span><strong>'+rssi+'</strong></div>'+'<div><span>Channel width</span><strong>'+bw+'</strong></div>';}"
"function fetchHalow(){fetch('/api/halow').then(function(r){return r.json();}).then(function(j){renderHalow(j);}).catch(function(){renderHalow(null);});}"
"function fetchWifi2g(){fetch('/api/wifi2g').then(function(r){return r.json();}).then(function(j){var ap=j&&j.ap?j.ap:{};var sta=j&&j.sta?j.sta:{};var mode=j&&j.backhaul_mode?j.backhaul_mode:'-';var apSsid=document.getElementById('wifi2gApSsid');if(apSsid)apSsid.textContent=ap.ssid||'-';var apClients=document.getElementById('wifi2gApClients');if(apClients)apClients.textContent=(ap.clients!=null)?String(ap.clients):'-';var apIp=document.getElementById('wifi2gApIp');if(apIp)apIp.textContent=ap.ip||'-';var apChan=document.getElementById('wifi2gApChan');if(apChan)apChan.textContent=(ap.channel!=null&&ap.channel!==0)?String(ap.channel):'-';var backhaul=document.getElementById('wifi2gBackhaul');if(backhaul)backhaul.textContent=mode==='wifi2g'?'2.4 GHz Wi-Fi':(mode==='halow'?'HaLow':'-');var staSsid=document.getElementById('wifi2gStaSsid');if(staSsid)staSsid.textContent=sta.ssid||'-';var staRssi=document.getElementById('wifi2gStaRssi');if(staRssi)staRssi.textContent=(sta.rssi_dbm!=null)?(sta.rssi_dbm+' dBm'):'-';var staIp=document.getElementById('wifi2gStaIp');if(staIp)staIp.textContent=sta.ip||'-';var ind=document.getElementById('wifi2gIndicator');if(ind){ind.classList.remove('ok','warn','crit');var apOk=!!(ap&&ap.ssid);if(!apOk){ind.classList.add('crit');}else if(mode==='wifi2g'&&!sta.connected){ind.classList.add('warn');}else{ind.classList.add('ok');}}}).catch(function(){var ind=document.getElementById('wifi2gIndicator');if(ind)ind.classList.remove('ok','warn','crit');});}"
"function reconnectHalow(){var status=document.getElementById('halowReconnectStatus');if(status)status.textContent='Reconnecting...';fetch('/api/halow/reconnect',{method:'POST'}).then(function(r){return r.json();}).then(function(j){if(status)status.textContent=(j&&j.ok)?'Requested.':'Failed.';setTimeout(function(){if(status)status.textContent='';},2000);}).catch(function(){if(status)status.textContent='Failed.';setTimeout(function(){if(status)status.textContent='';},2000);});}"
"function fetchSensors(){fetch('/api/sensors').then(function(r){return r.json();}).then(function(j){var n=j.nodes||[];var grid=document.getElementById('sensorCards');var sumT=0;var sumH=0;var sumA=0;var count=0;var now=Date.now();var selectedNode=null;if(!selectedSensorMac){for(var i=0;i<n.length;i++){if(n[i]&&n[i].mac&&!hiddenSensors[n[i].mac]){selectedSensorMac=n[i].mac;break;}}}var html=n.map(function(n){if(!n||!n.mac||hiddenSensors[n.mac]){return '';}if(selectedSensorMac&&n.mac===selectedSensorMac){selectedNode=n;}var meta=touchSensorMeta(n);var isStale=(now-meta.lastUpdate)>60000;var pulse=now<meta.pulseUntil;var tempVal=(n.temperature===null||n.temperature===undefined)?null:Number(n.temperature);var humVal=(n.humidity===null||n.humidity===undefined)?null:Number(n.humidity);var presVal=(n.pressure===null||n.pressure===undefined)?null:Number(n.pressure);var gasVal=(n.gas===null||n.gas===undefined)?null:Number(n.gas);var hasEnv=(tempVal!==null&&isFinite(tempVal))||(humVal!==null&&isFinite(humVal))||(presVal!==null&&isFinite(presVal))||(gasVal!==null&&isFinite(gasVal));var tempF=(tempVal!==null&&isFinite(tempVal))?c2f(tempVal):null;var aqi=gasToAqi(gasVal);var lbl=(n.label||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')||'-';var lastMotion='';if(n.last_motion_ms&&n.uptime_ms&&Number(n.uptime_ms)>=Number(n.last_motion_ms)){lastMotion=formatUptime(Number(n.uptime_ms)-Number(n.last_motion_ms));}var rssi=(n.rssi_dbm===null||n.rssi_dbm===undefined)?'':(n.rssi_dbm+' dBm');var dismissed=isDismissed(n.mac,Number(n.trigger_count));var isAlarm=(n.motion==1&&!dismissed);var motionText=(n.motion==1?(isAlarm?'Yes':'Cleared'):'No');var tempText=(tempF===null)?'':tempF.toFixed(1);var humText=fmtFixed(humVal,1);var presText=fmtFixed(presVal,1);var aqiText=(aqi===null)?'':String(aqi);var uptimeText=(n.uptime_ms===null||n.uptime_ms===undefined)?'':formatUptime(n.uptime_ms);var triggerText=(n.trigger_count===null||n.trigger_count===undefined)?'':String(n.trigger_count);if(tempF!==null&&humVal!==null&&isFinite(humVal)&&aqi!==null){sumT+=Number(tempF);sumH+=Number(humVal);sumA+=Number(aqi);count++;}var rows='';rows+=row('Motion',motionText,'sensor-motion');rows+=row('Last motion',lastMotion,'');rows+=row('RSSI',rssi,'');rows+=row('T (°F)',tempText,'');rows+=row('H (%)',humText,'');rows+=row('P (hPa)',presText,'');rows+=row('AQI',aqiText,'');rows+=row('Triggers',triggerText,'');rows+=row('Uptime',uptimeText,'');if(!hasEnv){rows+=row('Env','N/A','');}var removeBtn=isStale?'<button type=\"button\" class=\"btnRemove\" data-mac=\"'+n.mac+'\">Remove</button>':'';var isSelected=(selectedSensorMac&&n.mac===selectedSensorMac);return '<div class=\"sensor-card'+(isAlarm?' motion':'')+(isStale?' stale':'')+(isSelected?' selected':'')+'\" data-mac=\"'+n.mac+'\" data-trigger=\"'+n.trigger_count+'\"'+(isAlarm?' title=\"Tap to clear alarm\"':'')+'>'+'<div class=\"sensor-head\"><div class=\"sensor-ident\"><span class=\"status-dot'+(pulse?' pulse':'')+'\"></span><div><div class=\"sensor-title\">'+lbl+'</div><div class=\"sensor-mac\">'+n.mac+'</div></div></div>'+'<div class=\"sensor-actions\"><button type=\"button\" class=\"btnEditLabel\" data-mac=\"'+n.mac+'\" data-label=\"'+(n.label||'').replace(/\"/g,'&quot;')+'\">Edit</button><button type=\"button\" class=\"btnReset\" data-mac=\"'+n.mac+'\">Reset</button>'+removeBtn+'</div></div>'+'<div class=\"sensor-data\">'+rows+'</div></div>';}).join('');grid.innerHTML=html;if(selectedSensorMac&&!selectedNode){selectedSensorMac=null;resetHistory();}if(selectedSensorMac&&selectedNode){var tSel=(selectedNode.temperature===null||selectedNode.temperature===undefined)?null:Number(selectedNode.temperature);var hSel=(selectedNode.humidity===null||selectedNode.humidity===undefined)?null:Number(selectedNode.humidity);var gSel=(selectedNode.gas===null||selectedNode.gas===undefined)?null:Number(selectedNode.gas);if(tSel!==null&&isFinite(tSel)&&hSel!==null&&isFinite(hSel)&&gSel!==null&&isFinite(gSel)){pushHistory(envHistory.t,c2f(tSel));pushHistory(envHistory.h,hSel);pushHistory(envHistory.a,gasToAqi(gSel));}drawEnvGraph();}else if(count>0){pushHistory(envHistory.t,sumT/count);pushHistory(envHistory.h,sumH/count);pushHistory(envHistory.a,sumA/count);drawEnvGraph();}grid.querySelectorAll('.btnEditLabel').forEach(function(b){b.onclick=function(){showLabelEdit(this.dataset.mac,this.dataset.label||'');};});grid.querySelectorAll('.btnReset').forEach(function(b){b.onclick=function(e){e.stopPropagation();resetTrigger(this.dataset.mac);};});grid.querySelectorAll('.btnRemove').forEach(function(b){b.onclick=function(e){e.stopPropagation();var mac=this.dataset.mac;if(!mac)return;hiddenSensors[mac]=true;saveHiddenSensors();if(selectedSensorMac===mac){selectedSensorMac=null;resetHistory();}var card=this.closest('.sensor-card');if(card)card.remove();};});grid.querySelectorAll('.sensor-card').forEach(function(card){card.onclick=function(e){if(e.target&&e.target.classList&&(e.target.classList.contains('btnEditLabel')||e.target.classList.contains('btnRemove')||e.target.classList.contains('btnReset')))return;var mac=this.dataset.mac;if(mac&&selectedSensorMac!==mac){selectedSensorMac=mac;resetHistory();}var trig=Number(this.dataset.trigger||0);if(!mac||!trig||!this.classList.contains('motion'))return;motionDismissed[mac]={trigger:trig,ts:Date.now()};saveMotionDismissed();this.classList.remove('motion');var m=this.querySelector('.sensor-motion');if(m)m.textContent='Cleared';};});});}"
"function fetchSensors(){fetch('/api/sensors').then(function(r){return r.json();}).then(function(j){var n=j.nodes||[];var grid=document.getElementById('sensorCards');var sumT=0;var sumH=0;var sumA=0;var count=0;var now=Date.now();var selectedNode=null;if(!selectedSensorMac){for(var i=0;i<n.length;i++){if(n[i]&&n[i].mac&&!hiddenSensors[n[i].mac]){selectedSensorMac=n[i].mac;break;}}}var html=n.map(function(n){if(!n||!n.mac||hiddenSensors[n.mac]){return '';}if(selectedSensorMac&&n.mac===selectedSensorMac){selectedNode=n;}var meta=touchSensorMeta(n);var isStale=(now-meta.lastUpdate)>60000;var pulse=now<meta.pulseUntil;var tempVal=(n.temperature===null||n.temperature===undefined)?null:Number(n.temperature);var humVal=(n.humidity===null||n.humidity===undefined)?null:Number(n.humidity);var presVal=(n.pressure===null||n.pressure===undefined)?null:Number(n.pressure);var gasVal=(n.gas===null||n.gas===undefined)?null:Number(n.gas);var hasEnv=(tempVal!==null&&isFinite(tempVal))||(humVal!==null&&isFinite(humVal))||(presVal!==null&&isFinite(presVal))||(gasVal!==null&&isFinite(gasVal));var tempF=(tempVal!==null&&isFinite(tempVal))?c2f(tempVal):null;var aqi=gasToAqi(gasVal);var lbl=(n.label||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')||'-';var lastMotion='';if(n.last_motion_ms&&n.uptime_ms&&Number(n.uptime_ms)>=Number(n.last_motion_ms)){lastMotion=formatUptime(Number(n.uptime_ms)-Number(n.last_motion_ms));}var rssi=(n.rssi_dbm===null||n.rssi_dbm===undefined)?'':(n.rssi_dbm+' dBm');var dismissed=isDismissed(n.mac,Number(n.trigger_count));var isAlarm=(n.motion==1&&!dismissed);var motionText=(n.motion==1?(isAlarm?'Yes':'Cleared'):'No');var tempText=(tempF===null)?'':tempF.toFixed(1);var humText=fmtFixed(humVal,1);var presText=fmtFixed(presVal,1);var aqiText=(aqi===null)?'':String(aqi);var uptimeText=(n.uptime_ms===null||n.uptime_ms===undefined)?'':formatUptime(n.uptime_ms);var triggerText=(n.trigger_count===null||n.trigger_count===undefined)?'':String(n.trigger_count);if(tempF!==null&&humVal!==null&&isFinite(humVal)&&aqi!==null){sumT+=Number(tempF);sumH+=Number(humVal);sumA+=Number(aqi);count++;}var rows='';rows+=row('Motion',motionText,'sensor-motion');rows+=row('Last motion',lastMotion,'');rows+=row('RSSI',rssi,'');rows+=row('T (°F)',tempText,'');rows+=row('H (%)',humText,'');rows+=row('P (hPa)',presText,'');rows+=row('AQI',aqiText,'');rows+=row('Triggers',triggerText,'');rows+=row('Uptime',uptimeText,'');if(!hasEnv){rows+=row('Env','N/A','');}var removeBtn=isStale?'<button type=\"button\" class=\"btnRemove\" data-mac=\"'+n.mac+'\">Remove</button>':'';var isSelected=(selectedSensorMac&&n.mac===selectedSensorMac);return '<div class=\"sensor-card'+(isAlarm?' motion':'')+(isStale?' stale':'')+(isSelected?' selected':'')+'\" data-mac=\"'+n.mac+'\" data-trigger=\"'+n.trigger_count+'\"'+(isAlarm?' title=\"Tap to clear alarm\"':'')+'>'+'<div class=\"sensor-head\"><div class=\"sensor-ident\"><span class=\"status-dot'+(pulse?' pulse':'')+'\"></span><div><div class=\"sensor-title\">'+lbl+'</div><div class=\"sensor-mac\">'+n.mac+'</div></div></div>'+'<div class=\"sensor-actions\"><button type=\"button\" class=\"btnEditLabel\" data-mac=\"'+n.mac+'\" data-label=\"'+(n.label||'').replace(/\"/g,'&quot;')+'\">Edit</button><button type=\"button\" class=\"btnReset\" data-mac=\"'+n.mac+'\">Reset</button>'+removeBtn+'</div></div>'+'<div class=\"sensor-data\">'+rows+'</div></div>';}).join('');grid.innerHTML=html;if(selectedSensorMac&&!selectedNode){selectedSensorMac=null;resetHistory();}var labelEl=document.getElementById('envGraphLabel');if(labelEl){if(selectedSensorMac&&selectedNode){labelEl.textContent=(selectedNode.label||selectedNode.mac||'Selected sensor');}else{labelEl.textContent='All sensors';}}if(selectedSensorMac&&selectedNode){var tSel=(selectedNode.temperature===null||selectedNode.temperature===undefined)?null:Number(selectedNode.temperature);var hSel=(selectedNode.humidity===null||selectedNode.humidity===undefined)?null:Number(selectedNode.humidity);var gSel=(selectedNode.gas===null||selectedNode.gas===undefined)?null:Number(selectedNode.gas);if(tSel!==null&&isFinite(tSel)&&hSel!==null&&isFinite(hSel)&&gSel!==null&&isFinite(gSel)){pushHistory(envHistory.t,c2f(tSel));pushHistory(envHistory.h,hSel);pushHistory(envHistory.a,gasToAqi(gSel));}drawEnvGraph();}else if(count>0){pushHistory(envHistory.t,sumT/count);pushHistory(envHistory.h,sumH/count);pushHistory(envHistory.a,sumA/count);drawEnvGraph();}grid.querySelectorAll('.btnEditLabel').forEach(function(b){b.onclick=function(){showLabelEdit(this.dataset.mac,this.dataset.label||'');};});grid.querySelectorAll('.btnReset').forEach(function(b){b.onclick=function(e){e.stopPropagation();resetTrigger(this.dataset.mac);};});grid.querySelectorAll('.btnRemove').forEach(function(b){b.onclick=function(e){e.stopPropagation();var mac=this.dataset.mac;if(!mac)return;hiddenSensors[mac]=true;saveHiddenSensors();if(selectedSensorMac===mac){selectedSensorMac=null;resetHistory();}var card=this.closest('.sensor-card');if(card)card.remove();};});grid.querySelectorAll('.sensor-card').forEach(function(card){card.onclick=function(e){if(e.target&&e.target.classList&&(e.target.classList.contains('btnEditLabel')||e.target.classList.contains('btnRemove')||e.target.classList.contains('btnReset')))return;var mac=this.dataset.mac;if(mac&&selectedSensorMac!==mac){selectedSensorMac=mac;resetHistory();}var trig=Number(this.dataset.trigger||0);if(!mac||!trig||!this.classList.contains('motion'))return;motionDismissed[mac]={trigger:trig,ts:Date.now()};saveMotionDismissed();this.classList.remove('motion');var m=this.querySelector('.sensor-motion');if(m)m.textContent='Cleared';};});});}"
"setInterval(fetchSensors,2000);fetchSensors();"
"setInterval(fetchHalow,5000);fetchHalow();"
"setInterval(fetchWifi2g,5000);fetchWifi2g();"
"var btnReconnect=document.getElementById('btnHalowReconnect');if(btnReconnect){btnReconnect.onclick=reconnectHalow;}"
"function setupToggle(btnId,cardId){var btn=document.getElementById(btnId);var card=document.getElementById(cardId);if(!card)return;function toggle(){var open=card.classList.toggle('open');if(btn)btn.textContent=open?'Hide':'Details';}if(btn){btn.onclick=function(e){e.stopPropagation();toggle();};}card.onclick=function(e){if(e.target&&e.target.closest&&e.target.closest('button'))return;toggle();};}"
"setupToggle('btnHalowToggle','halowCard');setupToggle('btnSystemToggle','systemCard');setupToggle('btnWifi2gToggle','wifi2gCard');"
"function gasToAqiLog(g){if(g===null||g===undefined||g==='')return null;var x=Number(g);if(!isFinite(x))return null;if(x<=0)return 500;if(x>=300)return 0;return Math.round(Math.max(0,Math.min(500,(300-x)/300*500)));}"
"function formatLogTime(ts){var t=Number(ts);if(!isFinite(t))return '-';if(t>1000000000000){var d=new Date(t);return d.toLocaleString();}return Math.round(t/1000)+'s';}"
"function fetchLog(){fetch('/api/log').then(function(r){return r.json();}).then(function(j){var e=j.entries||[];var tbody=document.getElementById('logRows');if(e.length===0){tbody.innerHTML='<tr><td colspan=\"9\">No log entries. Data is stored when sensors report.</td></tr>';return;}tbody.innerHTML=e.map(function(x){var envMissing=(x.temperature==0||x.temperature===null||x.temperature===undefined)&&(x.humidity==0||x.humidity===null||x.humidity===undefined)&&(x.pressure==0||x.pressure===null||x.pressure===undefined)&&(x.gas==0||x.gas===null||x.gas===undefined);var tempF=!envMissing&&isFinite(Number(x.temperature))?(Number(x.temperature)*9/5+32):null;var aqi=envMissing?null:gasToAqiLog(x.gas);var lbl=(x.label||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')||'-';var tText=(tempF===null)?'-':tempF.toFixed(1);var hText=envMissing?'-':fmtFixed(x.humidity,1);var pText=envMissing?'-':fmtFixed(x.pressure,1);var aText=(aqi===null)?'-':String(aqi);return '<tr'+(x.motion==1?' class=\"motion\"':'')+'>'+'<td>'+formatLogTime(x.ts_ms)+'</td><td>'+x.mac+'</td><td>'+lbl+'</td><td>'+(x.motion==1?'Yes':'No')+'</td><td>'+tText+'</td><td>'+hText+'</td><td>'+pText+'</td><td>'+aText+'</td><td>'+formatUptime(x.uptime_ms)+'</td></tr>';}).join('');});}"
"document.getElementById('btnClearLog').onclick=function(){if(confirm('Clear all stored sensor log data?')){fetch('/api/log/clear',{method:'POST'}).then(function(){fetchLog();});};};"
"var camToggle=document.getElementById('camEnable');"
"var camStatus=document.getElementById('camStatus');"
"var camUrls=[];"
"var camPref=localStorage.getItem('camsEnabled');"
"if(camPref===null){localStorage.setItem('camsEnabled','0');camPref='0';}"
"camToggle.checked=camPref==='1';"
"function renderCamGrid(urls){var grid=document.getElementById('camGrid');if(!camToggle.checked){grid.innerHTML='<div class=\"cam-empty\">Cameras are disabled.</div>';return;}if(urls.length===0){grid.innerHTML='<div class=\"cam-empty\">No cameras configured.</div>';return;}grid.innerHTML=urls.map(function(url){return '<div class=\"cam-box\"><img src=\"'+url+'\" alt=\"\" onerror=\"this.style.background=\\'#0f141c\\'\"></div>';}).join('');}"
"function updateCamAvailability(urls){camUrls=urls.filter(Boolean);var has=camUrls.length>0;camToggle.disabled=!has;if(!has){camStatus.textContent='No cameras configured.';camToggle.checked=false;localStorage.setItem('camsEnabled','0');}else{camStatus.textContent=camToggle.checked?'Cameras enabled.':'Cameras disabled.';}var statCameras=document.getElementById('statCameras');if(statCameras)statCameras.textContent=String(camUrls.length);var statCamEnabled=document.getElementById('statCamEnabled');if(statCamEnabled)statCamEnabled.textContent=camToggle.checked?'Yes':'No';renderCamGrid(camUrls);}"
"camToggle.onchange=function(){if(camToggle.checked&&camUrls.length===0){camToggle.checked=false;camStatus.textContent='No cameras configured.';localStorage.setItem('camsEnabled','0');renderCamGrid([]);return;}localStorage.setItem('camsEnabled',camToggle.checked?'1':'0');camStatus.textContent=camToggle.checked?'Cameras enabled.':'Cameras disabled.';var statCamEnabled=document.getElementById('statCamEnabled');if(statCamEnabled)statCamEnabled.textContent=camToggle.checked?'Yes':'No';renderCamGrid(camUrls);};"
"function loadCameras(){fetch('/api/cameras').then(function(r){return r.json();}).then(function(j){var u=j.urls||[];document.getElementById('camInputs').innerHTML=[0,1,2,3].map(function(i){return '<input class=\"cam-url\" type=\"url\" placeholder=\"Camera '+(i+1)+'\" value=\"'+(u[i]||'')+'\" style=\"width:100%;max-width:400px;margin:4px 0\">';}).join('');updateCamAvailability(u);});}"
"function fetchDebug(){fetch('/api/debug').then(function(r){return r.json();}).then(function(j){updateTimeSync(j);var statNodes=document.getElementById('statNodes');if(statNodes)statNodes.textContent=(j&&j.node_count!=null)?String(j.node_count):'-';var heapFree=document.getElementById('statHeapFree');if(heapFree)heapFree.textContent=(j&&j.heap_free!=null)?fmtBytes(j.heap_free):'-';var heapUsed=document.getElementById('statHeapUsed');if(heapUsed)heapUsed.textContent=(j&&j.heap_used!=null)?fmtBytes(j.heap_used):'-';var heapMin=document.getElementById('statHeapMinFree');if(heapMin)heapMin.textContent=(j&&j.heap_min_free!=null)?fmtBytes(j.heap_min_free):'-';var heapPct=document.getElementById('statHeapPct');if(heapPct)heapPct.textContent=(j&&j.heap_used_pct!=null)?(String(j.heap_used_pct)+'%'):'-';var sysInd=document.getElementById('systemIndicator');if(sysInd){sysInd.classList.remove('ok','warn','crit');var pct=(j&&j.heap_used_pct!=null)?Number(j.heap_used_pct):null;if(pct!==null&&isFinite(pct)){if(pct>=90){sysInd.classList.add('crit');}else if(pct>=80){sysInd.classList.add('warn');}else{sysInd.classList.add('ok');}}}}).catch(function(){timeSyncValid=false;var statNodes=document.getElementById('statNodes');if(statNodes)statNodes.textContent='-';var heapFree=document.getElementById('statHeapFree');if(heapFree)heapFree.textContent='-';var heapUsed=document.getElementById('statHeapUsed');if(heapUsed)heapUsed.textContent='-';var heapMin=document.getElementById('statHeapMinFree');if(heapMin)heapMin.textContent='-';var heapPct=document.getElementById('statHeapPct');if(heapPct)heapPct.textContent='-';var sysInd=document.getElementById('systemIndicator');if(sysInd)sysInd.classList.remove('ok','warn','crit');});}"
"document.querySelector('[data-tab=\"cameras\"]').onclick=loadCameras;"
"document.getElementById('btnSaveCam').onclick=function(){var u=Array.from(document.querySelectorAll('#camInputs .cam-url')).map(function(i){return i.value.trim();}).filter(Boolean);fetch('/api/cameras',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(u)});loadCameras();};"
"document.querySelectorAll('.tabs button').forEach(function(b){b.onclick=function(){document.querySelectorAll('.tabs button').forEach(function(x){x.classList.remove('active');});document.querySelectorAll('.panel').forEach(function(x){x.classList.remove('active');});b.classList.add('active');document.getElementById(b.dataset.tab).classList.add('active');if(b.dataset.tab==='cameras')loadCameras();if(b.dataset.tab==='motion')fetchSensors();if(b.dataset.tab==='log')fetchLog();if(b.dataset.tab==='system'){fetchDebug();fetchHalow();fetchWifi2g();}};});"
"fetchDebug();setInterval(fetchDebug,5000);"
"</script></body></html>";

const char *sensor_gateway_get_dashboard_html(void) { return s_html; }
